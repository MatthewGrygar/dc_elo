<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ELO ≈æeb≈ô√≠ƒçek</title>

  <style>
    :root { color-scheme: light dark; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(900px 500px at 80% 0%, rgba(255,215,0,.08), transparent 60%),
                  #0f1115;
      color:#eef2ff;
    }

    header{
      padding:18px 18px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(15,17,21,.6);
      backdrop-filter: blur(10px);
      position: sticky;
      top:0;
      z-index:5;
    }
    header .wrap{
      max-width:1150px;
      margin:0 auto;
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
    }
    h1{ margin:0 0 6px; font-size:26px; letter-spacing:.2px; }
    .muted{ opacity:.78; }
    .credit{ margin-top:6px; }

    .container{
      max-width:1150px;
      margin:0 auto;
      padding: 0 16px;
    }

    main{ max-width:1150px; margin:0 auto; padding:16px; }

    .card{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:20px;
      overflow:hidden;
      background:rgba(255,255,255,.035);
      box-shadow:0 18px 55px rgba(0,0,0,.35);
    }

    .toolbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
    }
    .left{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .right{ display:flex; gap:10px; align-items:center; }

    .badge{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      white-space:nowrap;
    }

    input[type="search"]{
      width:min(380px, 70vw);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.18);
      color:inherit;
      outline:none;
    }
    input[type="search"]:focus{
      border-color:rgba(255,255,255,.28);
      box-shadow:0 0 0 4px rgba(255,255,255,.06);
    }

    button{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.18);
      color:inherit;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover{ background: rgba(255,255,255,.06); }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    .btnPrimary{
      border-color: rgba(255,255,255,.22);
      background: rgba(255,255,255,.08);
      font-weight: 900;
      letter-spacing: .04em;
      text-transform: uppercase;
      padding: 10px 14px;
    }
    .btnPrimary:hover{ background: rgba(255,255,255,.12); }

    /* Header left (logo + text) */
    .headerLeft{
      display:flex;
      gap:14px;
      align-items:flex-start;
    }
    .logo{
      width:46px;
      height:46px;
      flex: 0 0 46px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .logo img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }

    /* Header right group */
    .headerRight{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    /* Info panel */
    .infoBar{
      margin:12px 0 12px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background: rgba(255,255,255,.03);
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    .infoItem{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 10px;
      background: rgba(0,0,0,.12);
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .infoItem b{
      font-size:11px;
      letter-spacing:.08em;
      text-transform: uppercase;
      opacity:.72;
      white-space:nowrap;
    }
    .infoItem span{
      font-variant-numeric: tabular-nums;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      text-align:right;
      min-width: 0;
    }
    @media (max-width: 860px){
      .infoBar{ grid-template-columns: 1fr 1fr; }
    }

    .tableWrap{ overflow:auto; }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:rgba(15,17,21,.92);
      backdrop-filter: blur(6px);
      border-bottom:1px solid rgba(255,255,255,.12);
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.85;
    }
    th, td{ text-align:left; padding:12px 12px; }
    tbody tr:nth-child(2n){ background: rgba(255,255,255,.02); }
    tbody tr:hover{ background: rgba(255,255,255,.055); }
    .num{ text-align:right; font-variant-numeric: tabular-nums; }
    .rank{ width:90px; font-variant-numeric: tabular-nums; }

    .playerBtn{
      border:none;
      background:none;
      color:inherit;
      cursor:pointer;
      padding:0;
      font:inherit;
      text-decoration: underline;
      text-decoration-color: rgba(255,255,255,.25);
      text-underline-offset:3px;
    }
    .playerBtn:hover{ text-decoration-color: rgba(255,255,255,.6); }

    .r1{ color:#ffd54a; font-weight:900; }
    .r2{ color:#d6dbe6; font-weight:900; }
    .r3{ color:#d29a6a; font-weight:900; }

    #error{ display:none; margin-top:12px; white-space:pre-wrap; color:#ff7a7a; }

    footer{
      padding:12px;
      opacity:.75;
      font-size:12px;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
    }

    /* Modal */
    .modalOverlay{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(6px);
      z-index:50;
      padding:18px;
    }
    .modal{
      max-width:1100px;
      margin:0 auto;
      height: calc(100vh - 36px);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(15,17,21,.92);
      box-shadow:0 30px 90px rgba(0,0,0,.6);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
    }
    .modalTitle{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .modalTitle b{
      font-size:16px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 70vw;
    }
    .modalTitle span{ font-size:12px; opacity:.75; }
    .modalBody{ padding:12px; overflow:auto; }

    /* HERO 2 columns */
    .heroGrid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:12px;
      margin-bottom:14px;
      align-items: stretch;
    }
    .box{
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .boxPad{ padding:14px; }

    .heroName{ font-size:22px; font-weight:900; margin:0 0 6px; }
    .rankLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .rankLine .muted{ opacity:.8; }
    .rankPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      white-space:nowrap;
    }

    .heroEloLabel{ opacity:.75; font-size:12px; }
    .heroElo{ font-size:44px; font-weight:900; line-height:1; margin:6px 0 0; }

    .statsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      margin-top:12px;
    }
    .statsGridRow2{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:8px;
      margin-top:8px;
    }
    .stat{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      background: rgba(255,255,255,.02);
    }
    .stat b{ display:block; font-size:12px; opacity:.75; letter-spacing:.06em; text-transform:uppercase; }
    .stat span{ display:block; margin-top:4px; font-size:16px; font-weight:900; }

    .statWin{ background: rgba(60, 220, 120, .10); border-color: rgba(60, 220, 120, .22); }
    .statLoss{ background: rgba(255, 90, 90, .10); border-color: rgba(255, 90, 90, .22); }
    .statDraw{ background: rgba(255, 170, 60, .10); border-color: rgba(255, 170, 60, .22); }

    .chartHead{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin-bottom:8px;
    }
    .chartHead b{ font-size:13px; letter-spacing:.08em; text-transform:uppercase; opacity:.9; }
    .chartHead span{ font-size:12px; opacity:.75; }
    #eloChart{ min-height: 220px; }

    .bigError{
      display:flex;
      align-items:center;
      gap:12px;
      border:1px solid rgba(255,122,122,.35);
      background: rgba(255,122,122,.08);
      color:#ffd0d0;
      border-radius:18px;
      padding:14px;
      margin-top:10px;
      font-weight:900;
    }
    .bigError .icon{ font-size:22px; }

    .sectionTitle{
      margin: 18px 0 10px;
      font-size: 13px;
      letter-spacing: .08em;
      text-transform: uppercase;
      opacity: .9;
    }

    .gridTableWrap{
      overflow:auto;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background: rgba(255,255,255,.02);
    }
    .gridTable{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
    }
    .gridTable td{
      border-top:1px solid rgba(255,255,255,.08);
      border-right:1px solid rgba(255,255,255,.08);
      padding:8px 10px;
      vertical-align:top;
      white-space:pre-wrap;
      font-size: 13px;
    }
    .gridTable tr:first-child td{ border-top:none; }
    .gridTable td:last-child{ border-right:none; }
    .gridTable tr:nth-child(2n) td{ background: rgba(255,255,255,.02); }

    @media (max-width: 980px){
      .heroGrid{ grid-template-columns: 1fr; }
      header .wrap{ flex-direction: column; }
      .headerRight{ justify-content:flex-start; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="headerLeft">
      <div class="logo">
        <img src="logo.png" alt="Logo" onerror="this.onerror=null;this.src='logo.jpg';" />
      </div>
      <div>
        <h1>ELO ≈æeb≈ô√≠ƒçek</h1>
        <div class="muted">Naƒç√≠t√°no z Google Sheets (list: ‚ÄúElo standings‚Äù).</div>
        <div class="credit muted">
          Za ve≈°ker√° data dƒõkujeme <b>Ervinovi Kuƒçovi</b>, kter√Ω data souƒçasnƒõ zpravuje:
        </div>
      </div>
    </div>

    <div class="headerRight">
      <div class="badge" id="lastDataBadge">naƒçteno: naƒç√≠t√°m‚Ä¶</div>
      <button class="btnPrimary" id="requestUploadBtn" type="button">ZA≈Ω√ÅDAT O NAHR√ÅN√ç DAT</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="infoBar" id="infoBar" aria-label="Souhrn">
    <div class="infoItem"><b>pr≈Ømƒõrn√© ELO</b><span id="avgElo">‚Äî</span></div>
    <div class="infoItem"><b>pr≈Ømƒõrn√Ω winrate</b><span id="avgWinrate">‚Äî</span></div>
    <div class="infoItem"><b>celkov√Ω poƒçet her</b><span id="totalGames">‚Äî</span></div>
    <div class="infoItem"><b>posledn√≠ turnaj</b><span id="lastTournament">‚Äî</span></div>
  </div>
</div>

<main>
  <div class="card">
    <div class="toolbar">
      <div class="left">
        <span id="status" class="badge">Naƒç√≠t√°m‚Ä¶</span>
        <input id="search" type="search" placeholder="Hledat hr√°ƒçe‚Ä¶" autocomplete="off" />
      </div>
      <div class="right">
        <button id="refresh" type="button">Znovu naƒç√≠st</button>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
        <tr>
          <th class="rank">Po≈ôad√≠</th>
          <th>Player</th>
          <th class="num">Rating</th>
          <th class="num">Games</th>
          <th class="num">Win</th>
          <th class="num">Loss</th>
          <th class="num">Draw</th>
          <th class="num">Winrate</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <footer>Tip: Klikni na jm√©no hr√°ƒçe pro detail. Po≈ôad√≠ je ‚Äûlocknut√©‚Äú po naƒçten√≠ dat.</footer>
  </div>

  <div id="error"></div>
</main>

<!-- Modal -->
<div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">
        <b id="modalName">Hr√°ƒç</b>
        <span id="modalSub">Naƒç√≠t√°m‚Ä¶</span>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="openSheetTabBtn" type="button">Otev≈ô√≠t Sheets</button>
        <button id="closeModalBtn" type="button">Zav≈ô√≠t</button>
      </div>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
  const SHEET_ID = "1y98bzsIRpVv0_cGNfbITapucO5A6izeEz5lTM92ZbIA";
  const ELO_SHEET_NAME = "Elo standings";
  const DATA_SHEET_NAME = "Data";

  const ELO_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(ELO_SHEET_NAME)}`;
  const DATA_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(DATA_SHEET_NAME)}`;

  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const errorEl = document.getElementById("error");
  const searchEl = document.getElementById("search");
  const refreshBtn = document.getElementById("refresh");
  const lastDataBadge = document.getElementById("lastDataBadge");

  const avgEloEl = document.getElementById("avgElo");
  const avgWinrateEl = document.getElementById("avgWinrate");
  const totalGamesEl = document.getElementById("totalGames");
  const lastTournamentEl = document.getElementById("lastTournament");
  const requestUploadBtn = document.getElementById("requestUploadBtn");

  const modalOverlay = document.getElementById("modalOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const openSheetTabBtn = document.getElementById("openSheetTabBtn");
  const modalName = document.getElementById("modalName");
  const modalSub = document.getElementById("modalSub");
  const modalBody = document.getElementById("modalBody");

  let allRows = [];
  let lastTournamentText = "";
  let lastLoadedAt = "";

  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function normalizeKey(s){
    return (s || "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu,"");
  }
  function setStatus(text){ statusEl.textContent = text; }
  function showError(msg){ errorEl.style.display="block"; errorEl.textContent = msg; }
  function hideError(){ errorEl.style.display="none"; errorEl.textContent=""; }
  function toNumber(x){
    if (x == null) return NaN;
    const s = x.toString().replace(/\s/g,"").replace(",",".");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }
  function safeInt(x){ return Number.isFinite(x) ? x.toFixed(0) : ""; }

  function formatNow(){
    return new Intl.DateTimeFormat("cs-CZ", {
      year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    }).format(new Date());
  }

  async function fetchUtf8Text(url){
    const res = await fetch(url, { cache: "no-store" });
    const buf = await res.arrayBuffer();
    const text = new TextDecoder("utf-8").decode(buf);
    return { res, text };
  }

  function parseCSV(csvText){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i=0;i<csvText.length;i++){
      const c = csvText[i];
      const next = csvText[i+1];
      if (c === '"' && inQuotes && next === '"'){ cur += '"'; i++; }
      else if (c === '"'){ inQuotes = !inQuotes; }
      else if (c === "," && !inQuotes){ row.push(cur); cur=""; }
      else if ((c === "\n" || c === "\r") && !inQuotes){
        if (c === "\r" && next === "\n") i++;
        row.push(cur); cur="";
        if (row.some(x => x.trim() !== "")) rows.push(row);
        row = [];
      } else cur += c;
    }
    if (cur.length || row.length){
      row.push(cur);
      if (row.some(x => x.trim() !== "")) rows.push(row);
    }
    return rows;
  }

  function rankCellHtml(rank){
    if (rank === 1) return `<span class="r1">üëë ${rank}</span>`;
    if (rank === 2) return `<span class="r2">${rank}</span>`;
    if (rank === 3) return `<span class="r3">${rank}</span>`;
    return `${rank}`;
  }

  function openModal(){
    modalOverlay.style.display="block";
    document.body.style.overflow="hidden";
  }
  function closeModal(){
    modalOverlay.style.display="none";
    document.body.style.overflow="";
    modalBody.innerHTML="";
  }

  function parseWinrateToNumber(winrateText){
    if (!winrateText) return NaN;
    const s = winrateText.toString().trim();
    if (!s) return NaN;
    if (s.includes("%")) return toNumber(s.replace("%",""));
    const n = toNumber(s);
    if (!Number.isFinite(n)) return NaN;
    if (n > 0 && n <= 1) return n * 100;
    return n;
  }

  // ‚úÖ MEDI√ÅN ELO + total games / 2
  function updateInfoBar(){
    const ratings = allRows.map(r => r.rating).filter(Number.isFinite).sort((a,b)=>a-b);
    const gamesArr = allRows.map(r => r.games).filter(Number.isFinite);
    const winrates = allRows.map(r => parseWinrateToNumber(r.winrate)).filter(Number.isFinite);

    // Median ELO
    let medianElo = NaN;
    if (ratings.length){
      const mid = Math.floor(ratings.length / 2);
      medianElo = (ratings.length % 2 === 1)
        ? ratings[mid]
        : (ratings[mid - 1] + ratings[mid]) / 2;
    }

    // Total games / 2
    const totalGamesRaw = gamesArr.length ? gamesArr.reduce((a,b)=>a+b,0) : NaN;
    const totalGames = Number.isFinite(totalGamesRaw) ? (totalGamesRaw / 2) : NaN;

    // Avg winrate
    const avgWinrate = winrates.length ? (winrates.reduce((a,b)=>a+b,0) / winrates.length) : NaN;

    avgEloEl.textContent = Number.isFinite(medianElo) ? medianElo.toFixed(0) : "‚Äî";
    totalGamesEl.textContent = Number.isFinite(totalGames) ? totalGames.toFixed(0) : "‚Äî";
    avgWinrateEl.textContent = Number.isFinite(avgWinrate) ? `${avgWinrate.toFixed(0)}%` : "‚Äî";
    lastTournamentEl.textContent = lastTournamentText || "‚Äî";
  }

  async function loadLastData(){
    lastLoadedAt = formatNow();
    lastDataBadge.textContent = `naƒçteno: ${lastLoadedAt}`;

    try{
      const u = new URL(DATA_CSV_URL);
      u.searchParams.set("_", Date.now().toString());
      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("HTML m√≠sto CSV");

      const rows = parseCSV(text);
      let last = "";
      for (let i=1;i<rows.length;i++){
        const v = (rows[i][1] ?? "").toString().trim(); // col B
        if (v) last = v;
      }
      lastTournamentText = last || "";
      updateInfoBar();
    } catch {
      lastTournamentText = "";
      updateInfoBar();
    }
  }

  function renderStandings(rows){
    const q = normalizeKey(searchEl.value);
    const filtered = rows.filter(r => !q || normalizeKey(r.player).includes(q));
    filtered.sort((a,b) => a.rank - b.rank);

    tbody.innerHTML = "";
    if (!filtered.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" class="muted">Nic nenalezeno.</td>`;
      tbody.appendChild(tr);
      return;
    }

    for (const r of filtered){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="rank">${rankCellHtml(r.rank)}</td>
        <td><button class="playerBtn" type="button">${escapeHtml(r.player)}</button></td>
        <td class="num">${Number.isFinite(r.rating) ? r.rating.toFixed(0) : ""}</td>
        <td class="num">${safeInt(r.games)}</td>
        <td class="num">${safeInt(r.win)}</td>
        <td class="num">${safeInt(r.loss)}</td>
        <td class="num">${safeInt(r.draw)}</td>
        <td class="num">${escapeHtml(r.winrate || "")}</td>
      `;
      tr.querySelector(".playerBtn")._playerObj = r;
      tbody.appendChild(tr);
    }
  }

  async function loadStandings(){
    hideError();
    setStatus("Naƒç√≠t√°m‚Ä¶");
    refreshBtn.disabled = true;

    try{
      const u = new URL(ELO_CSV_URL);
      u.searchParams.set("_", Date.now().toString());
      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("M√≠sto CSV p≈ôi≈°lo HTML.");

      const rows = parseCSV(text);
      if (!rows.length) throw new Error("Pr√°zdn√© CSV.");

      const headers = rows[0].map(h => normalizeKey(h));
      const idx = (name) => headers.indexOf(name);

      const iPlayer  = idx("player");
      const iRating  = idx("rating");
      const iGames   = idx("games");
      const iWin     = idx("win");
      const iLoss    = idx("loss");
      const iDraw    = idx("draw");
      const iWinrate = headers.findIndex(h => h === "winrate" || h.includes("winrate"));

      if ([iPlayer,iRating,iGames,iWin,iLoss,iDraw].some(i => i === -1) || iWinrate === -1){
        throw new Error(`Nena≈°el jsem sloupce player,rating,games,win,loss,draw,winrate. Hlaviƒçky: ${headers.join(", ")}`);
      }

      const loaded = rows.slice(1).map(r => ({
        player: (r[iPlayer] ?? "").trim(),
        rating: toNumber(r[iRating]),
        games:  toNumber(r[iGames]),
        win:    toNumber(r[iWin]),
        loss:   toNumber(r[iLoss]),
        draw:   toNumber(r[iDraw]),
        winrate:(r[iWinrate] ?? "").toString().trim()
      })).filter(x => x.player.length > 0);

      loaded.sort((a,b) => (b.rating || -Infinity) - (a.rating || -Infinity));
      allRows = loaded.map((p,i) => ({ ...p, rank: i + 1 }));

      setStatus(`Naƒçteno: ${allRows.length}`);
      renderStandings(allRows);
      updateInfoBar();
    } catch(e){
      setStatus("Chyba");
      showError(String(e?.message || e));
    } finally {
      refreshBtn.disabled = false;
    }
  }

  async function loadAll(){
    await Promise.all([loadStandings(), loadLastData()]);
  }

  function buildHero2col(playerObj){
    const eloText = Number.isFinite(playerObj.rating) ? playerObj.rating.toFixed(0) : "";
    const rankRight = `<span class="rankPill">${rankCellHtml(playerObj.rank)}</span>`;

    return `
      <div class="heroGrid">
        <div class="box boxPad">
          <div class="heroName">${escapeHtml(playerObj.player)}</div>

          <div class="rankLine">
            <div class="muted">Po≈ôad√≠ v ≈æeb≈ô√≠ƒçku</div>
            ${rankRight}
          </div>

          <div style="margin-top:10px;">
            <div class="heroEloLabel">aktu√°ln√≠ rating</div>
            <div class="heroElo">${escapeHtml(eloText)}</div>
          </div>

          <div class="statsGrid">
            <div class="stat"><b>games</b><span>${safeInt(playerObj.games)}</span></div>
            <div class="stat"><b>winrate</b><span>${escapeHtml(playerObj.winrate || "")}</span></div>
          </div>

          <div class="statsGridRow2">
            <div class="stat statWin"><b>win</b><span>${safeInt(playerObj.win)}</span></div>
            <div class="stat statLoss"><b>loss</b><span>${safeInt(playerObj.loss)}</span></div>
            <div class="stat statDraw"><b>draw</b><span>${safeInt(playerObj.draw)}</span></div>
          </div>
        </div>

        <div class="box boxPad">
          <div class="chartHead">
            <b>V√Ωvoj ELO</b>
            <span id="chartMeta" class="muted">Naƒç√≠t√°m data hr√°ƒçe‚Ä¶</span>
          </div>
          <div id="eloChart" class="muted">Naƒç√≠t√°m data hr√°ƒçe‚Ä¶</div>
        </div>
      </div>
    `;
  }

  function buildRawGridTable(grid){
    const trimmed = grid.map(r => {
      let last = -1;
      for (let c=0;c<r.length;c++){
        if ((r[c] ?? "").toString().trim() !== "") last = c;
      }
      return r.slice(0, Math.max(0, last + 1));
    }).filter(r => r.some(cell => (cell ?? "").toString().trim() !== ""));

    if (!trimmed.length) return `<div class="muted">≈Ω√°dn√° data.</div>`;

    const maxCols = Math.min(16, Math.max(...trimmed.map(r => r.length)));
    const rowsHtml = trimmed.map(r => {
      let cells = "";
      for (let c=0;c<maxCols;c++){
        const v = (r[c] ?? "").toString();
        cells += `<td>${escapeHtml(v)}</td>`;
      }
      return `<tr>${cells}</tr>`;
    }).join("");

    return `
      <div class="gridTableWrap">
        <table class="gridTable">${rowsHtml}</table>
      </div>
    `;
  }

  function extractEloSeriesFromGrid(grid){
    const series = [];
    const norm = (s) => normalizeKey((s ?? "").toString()).replace(/\s+/g," ").trim();
    const isRound = (s) => /^\s*\d+\s*$/.test((s ?? "").toString());

    for (let r=0;r<grid.length;r++){
      const rowN = (grid[r] || []).map(norm);
      const iRound = rowN.indexOf("round");
      const iElo = rowN.indexOf("elo");
      const iMatch = rowN.indexOf("matchid");

      if (iRound !== -1 && iElo !== -1 && iMatch !== -1){
        for (let k=r+1;k<grid.length;k++){
          const rr = grid[k] || [];
          if (!isRound(rr[iRound])) break;
          const eloVal = toNumber(rr[iElo] ?? "");
          if (Number.isFinite(eloVal)) series.push(eloVal);
        }
      }
    }
    return series;
  }

  function buildSvgLineChart(values){
    const clean = values.filter(v => Number.isFinite(v));
    if (clean.length < 2){
      return `<div class="muted">Graf nelze vykreslit (m√°lo dat).</div>`;
    }

    const w = 960, h = 220, padX = 18, padY = 16;
    const min = Math.min(...clean);
    const max = Math.max(...clean);
    const span = Math.max(1, max - min);

    const n = values.length;
    const x = (i) => padX + (i * (w - padX*2)) / Math.max(1, n - 1);
    const y = (v) => (h - padY) - ((v - min) * (h - padY*2)) / span;

    let d = "";
    let started = false;
    for (let i=0;i<values.length;i++){
      const v = values[i];
      if (!Number.isFinite(v)) continue;
      d += (started ? " L " : " M ") + x(i).toFixed(2) + " " + y(v).toFixed(2);
      started = true;
    }

    const grid = [0, .5, 1].map(t => {
      const yy = padY + (1 - t) * (h - padY*2);
      return `<line x1="${padX}" y1="${yy}" x2="${w-padX}" y2="${yy}" stroke="rgba(255,255,255,.10)" />`;
    }).join("");

    return `
      <svg viewBox="0 0 ${w} ${h}" width="100%" height="220" role="img" aria-label="ELO chart">
        ${grid}
        <path d="${d}" fill="none" stroke="rgba(255,255,255,.85)" stroke-width="2.5" />
        <text x="${padX}" y="${padY-2}" fill="rgba(255,255,255,.65)" font-size="11">min ${min}</text>
        <text x="${w-padX}" y="${padY-2}" text-anchor="end" fill="rgba(255,255,255,.65)" font-size="11">max ${max}</text>
      </svg>
    `;
  }

  async function loadPlayerDetail(playerObj){
    modalName.textContent = playerObj.player;
    modalSub.textContent = "Naƒç√≠t√°m detail‚Ä¶";
    modalBody.innerHTML = buildHero2col(playerObj) + `<div class="muted">Naƒç√≠t√°m data listu‚Ä¶</div>`;
    openModal();

    openSheetTabBtn.onclick = () => {
      window.open(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`, "_blank", "noopener,noreferrer");
    };

    const playerSheetUrl =
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(playerObj.player)}`;

    try{
      const u = new URL(playerSheetUrl);
      u.searchParams.set("_", Date.now().toString());

      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("HTML m√≠sto CSV");

      const grid = parseCSV(text);
      if (!grid.length) throw new Error("EMPTY");

      const series = extractEloSeriesFromGrid(grid);
      const chartEl = document.getElementById("eloChart");
      const chartMeta = document.getElementById("chartMeta");

      chartEl.innerHTML = buildSvgLineChart(series);
      if (series.length){
        chartMeta.textContent = `z√°pas≈Ø: ${series.length} ‚Ä¢ posledn√≠ ELO: ${series[series.length-1].toFixed(0)}`;
      } else {
        chartMeta.textContent = `ELO sloupec nenalezen`;
      }

      modalSub.textContent = "Detail hr√°ƒçe";
      modalBody.innerHTML = buildHero2col(playerObj) +
        `<div class="sectionTitle">Data z listu hr√°ƒçe</div>` +
        buildRawGridTable(grid);

    } catch {
      modalSub.textContent = "Detail hr√°ƒçe";
      modalBody.innerHTML = buildHero2col(playerObj) +
        `<div class="bigError"><div class="icon">‚ùå</div> Podrobn√° data hr√°ƒçe nenalezena</div>` +
        `<div class="muted" style="margin-top:10px;">(Nenalezen list se stejn√Ωm n√°zvem jako hr√°ƒç.)</div>`;
    }
  }

  // events
  searchEl.addEventListener("input", () => renderStandings(allRows));
  refreshBtn.addEventListener("click", loadAll);
  requestUploadBtn.addEventListener("click", () => {
    window.location.href = "https://www.seznam.cz/";
  });

  tbody.addEventListener("click", (e) => {
    const btn = e.target.closest(".playerBtn");
    if (!btn) return;
    const playerObj = btn._playerObj;
    if (!playerObj) return;
    loadPlayerDetail(playerObj);
  });

  closeModalBtn.addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) closeModal(); });
  window.addEventListener("keydown", (e) => { if (e.key === "Escape" && modalOverlay.style.display === "block") closeModal(); });

  // init
  loadAll();
</script>
</body>
</html>
