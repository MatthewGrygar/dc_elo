<!doctype html>
<html lang="cs" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DC ELO ≈æeb≈ô√≠ƒçek</title>

  <style>
    html[data-theme="dark"]{
      --bg0:#0f1115; --bg1:rgba(15,17,21,.60);
      --text:#eef2ff; --muted:rgba(238,242,255,.78);
      --border:rgba(255,255,255,.12); --border2:rgba(255,255,255,.10);
      --panel:rgba(255,255,255,.035); --panel2:rgba(255,255,255,.03);
      --chip:rgba(255,255,255,.06); --chip2:rgba(0,0,0,.18);
      --shadow:0 18px 55px rgba(0,0,0,.35);
      --thead:rgba(15,17,21,.92);
      --hover:rgba(255,255,255,.055); --altrow:rgba(255,255,255,.02);
      --glow:rgba(255,255,255,.06);
      --btnPrimaryBg:rgba(255,255,255,.08); --btnPrimaryBd:rgba(255,255,255,.22);

      --winBg:rgba(60,220,120,.10); --winBd:rgba(60,220,120,.22);
      --lossBg:rgba(255,90,90,.10); --lossBd:rgba(255,90,90,.22);
      --drawBg:rgba(255,170,60,.10); --drawBd:rgba(255,170,60,.22);

      --chartLine: rgba(255, 90, 90, .75);
      --chartDot: rgba(255, 90, 90, .95);
      --chartGrid: rgba(160,160,160,.18);
      --chartAxis: rgba(200,200,200,.35);
      --chartText: rgba(220,220,220,.78);

      --dangerBg: rgba(255, 90, 90, .10);
      --dangerBd: rgba(255, 90, 90, .22);
      --dangerTx: rgba(255, 200, 200, .92);
    }

    html[data-theme="light"]{
      --bg0:#f3efe6; --bg1:rgba(243,239,230,.70);
      --text:#151515; --muted:rgba(21,21,21,.70);
      --border:rgba(0,0,0,.10); --border2:rgba(0,0,0,.08);
      --panel:rgba(255,255,255,.70); --panel2:rgba(255,255,255,.55);
      --chip:rgba(255,255,255,.70); --chip2:rgba(255,255,255,.72);
      --shadow:0 18px 50px rgba(0,0,0,.12);
      --thead:rgba(255,255,255,.92);
      --hover:rgba(0,0,0,.035); --altrow:rgba(0,0,0,.018);
      --glow:rgba(0,0,0,.05);
      --btnPrimaryBg:rgba(255,255,255,.75); --btnPrimaryBd:rgba(0,0,0,.14);

      --winBg:rgba(60,220,120,.14); --winBd:rgba(20,150,70,.22);
      --lossBg:rgba(255,90,90,.14); --lossBd:rgba(190,40,40,.22);
      --drawBg:rgba(255,170,60,.16); --drawBd:rgba(180,110,20,.22);

      --chartLine: rgba(210, 60, 60, .70);
      --chartDot: rgba(210, 60, 60, .92);
      --chartGrid: rgba(0,0,0,.10);
      --chartAxis: rgba(0,0,0,.24);
      --chartText: rgba(0,0,0,.70);

      --dangerBg: rgba(210, 60, 60, .10);
      --dangerBd: rgba(210, 60, 60, .22);
      --dangerTx: rgba(120, 20, 20, .92);
    }

    :root{ color-scheme: light dark; }

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(255,215,0,.08), transparent 60%),
        radial-gradient(900px 500px at 20% 80%, rgba(80,120,255,.06), transparent 60%),
        var(--bg0);
    }
    html[data-theme="light"] body{
      background:
        radial-gradient(900px 420px at 10% 0%, rgba(255,255,255,.80), transparent 55%),
        radial-gradient(800px 380px at 90% 10%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(900px 500px at 25% 95%, rgba(210,190,160,.35), transparent 60%),
        linear-gradient(120deg, rgba(230,220,205,.55), transparent 45%),
        linear-gradient(25deg, rgba(255,255,255,.65), transparent 55%),
        var(--bg0);
    }

    header{
      padding:18px 18px 14px;
      border-bottom:1px solid var(--border2);
      background:var(--bg1);
      backdrop-filter: blur(10px);
      position:sticky; top:0; z-index:5;
    }
    header .wrap{
      max-width:1150px; margin:0 auto;
      display:flex; gap:16px; align-items:flex-start; justify-content:space-between;
    }

    h1{ margin:0 0 4px; font-size:26px; letter-spacing:.2px; }
    .subtitle{ margin:0 0 8px; font-size:12px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); }
    .muted{ opacity:1; color:var(--muted); }
    .credit{ margin-top:6px; }

    .headerLeft{ display:flex; gap:16px; align-items:flex-start; }
    .logo{
      width:118px; height:118px; flex:0 0 118px;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden; margin-top:-4px;
    }
    .logo img{
      width:100%; height:100%; object-fit:contain; display:block;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.22));
    }

    .headerRight{ display:flex; flex-direction:column; gap:10px; align-items:flex-end; width:auto; }
    .headerRightTop{ display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }

    .badge{
      font-size:12px; padding:7px 10px; border-radius:999px;
      border:1px solid var(--border); background:var(--chip); white-space:nowrap;
    }
    button{
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--border); background:var(--chip2);
      color:inherit; cursor:pointer; white-space:nowrap;
    }
    button:hover{ filter: brightness(1.06); }
    .btnPrimary{
      border-color:var(--btnPrimaryBd); background:var(--btnPrimaryBg);
      font-weight:900; letter-spacing:.04em; text-transform:uppercase;
      padding:10px 14px;
    }

    .themeToggle{
      padding:7px 10px; border-radius:999px; font-size:13px;
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border); background:var(--chip);
      cursor:pointer; user-select:none;
    }
    .themeToggle .dot{ width:8px; height:8px; border-radius:50%; background:rgba(120,120,120,.6); display:inline-block; }

    .container{ max-width:1150px; margin:0 auto; padding:0 16px; }
    main{ max-width:1150px; margin:0 auto; padding:16px; }

    .infoBar{
      margin:12px 0 12px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--panel2);
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    .infoItem{
      border:1px solid var(--border2);
      border-radius:14px;
      padding:10px 10px;
      background:rgba(0,0,0,.06);
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    html[data-theme="light"] .infoItem{ background:rgba(255,255,255,.50); }
    .infoItem b{
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.85;
      white-space:nowrap;
    }
    .infoItem span{
      font-variant-numeric: tabular-nums;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-align:right;
      min-width:0;
    }

    .card{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:20px;
      overflow:hidden;
      background:var(--panel);
      box-shadow:var(--shadow);
    }

    /* Toolbar */
    .toolbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:12px;
      border-bottom:1px solid var(--border2);
      background:var(--panel2);
    }
    .left{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .right{ display:flex; gap:10px; align-items:center; }

    input[type="search"]{
      width:min(520px, 70vw);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--chip2);
      color:inherit;
      outline:none;
    }
    input[type="search"]:focus{
      border-color:rgba(120,120,120,.35);
      box-shadow:0 0 0 4px var(--glow);
    }

    .tableWrap{ overflow:auto; }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{
      position:sticky; top:0; z-index:2;
      background:var(--thead);
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--border2);
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.85;
    }
    th, td{ text-align:left; padding:12px 12px; }
    tbody tr:nth-child(2n){ background:var(--altrow); }
    tbody tr:hover{ background:var(--hover); }
    .num{ text-align:right; font-variant-numeric: tabular-nums; }
    .rank{ width:90px; font-variant-numeric: tabular-nums; }
    .playerBtn{
      border:none; background:none; color:inherit; cursor:pointer; padding:0; font:inherit;
      text-decoration:underline; text-decoration-color:rgba(120,120,120,.35); text-underline-offset:3px;
    }
    .r1{ color:#ffd54a; font-weight:900; }
    .r2{ color:#b6bcc8; font-weight:900; }
    html[data-theme="light"] .r2{ color:#6b6f77; }
    .r3{ color:#d29a6a; font-weight:900; }

    footer{
      padding:12px;
      opacity:.85;
      font-size:12px;
      border-top:1px solid var(--border2);
      background:var(--panel2);
      color:var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    /* Modal */
    .modalOverlay{
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      backdrop-filter: blur(6px);
      z-index:50; padding:18px;
    }
    .modal{
      max-width:1100px; margin:0 auto;
      height:calc(100vh - 36px);
      border-radius:20px;
      border:1px solid var(--border);
      background:var(--thead);
      box-shadow:0 30px 90px rgba(0,0,0,.35);
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px;
      border-bottom:1px solid var(--border2);
      background:var(--panel2);
    }
    .modalTitle{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .modalTitle b{ font-size:16px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:70vw; }
    .modalTitle span{ font-size:12px; color:var(--muted); }
    .modalBody{ padding:12px; overflow:auto; }

    .btnDanger{
      border-color:var(--dangerBd);
      background:var(--dangerBg);
      color:var(--dangerTx);
      font-weight:900;
      padding:10px 14px;
    }

    /* Player hero */
    .heroGrid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:12px;
      margin-bottom:14px;
      align-items:stretch;
    }
    .box{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--panel);
      overflow:hidden;
    }
    .boxPad{ padding:14px; }

    .leftPanel{
      display:flex;
      flex-direction:column;
      min-height: 420px;
    }
    .leftTop{ flex: 1 1 auto; }
    .leftBottom{ margin-top:auto; }

    .heroName{
      font-size:38px;
      font-weight:950;
      margin:0 0 10px;
      line-height:1.03;
      letter-spacing:.2px;
    }
    .rankLine{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .rankLine .muted{ font-size:13px; }

    .rankPill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      background:var(--chip);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      white-space:nowrap;
    }

    .heroEloLabel{ color:var(--muted); font-size:12px; }
    .heroElo{
      font-size:60px;
      font-weight:950;
      line-height:1;
      margin:7px 0 0;
      letter-spacing:.4px;
    }

    .statsGrid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:14px; }
    .statsGridRow2{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px; }

    .stat{
      border:1px solid var(--border2);
      border-radius:14px;
      padding:12px;
      background:var(--panel2);
      min-width:0;
      display:flex;
      flex-direction:column;
      justify-content:space-between; /* label top, value bottom */
      min-height:78px;
    }
    .stat b{
      display:block;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .stat span{
      display:block;
      margin-top:10px;
      font-size:18px;
      font-weight:900;
      align-self:flex-start;
    }

    .statWin{ background:var(--winBg); border-color:var(--winBd); }
    .statLoss{ background:var(--lossBg); border-color:var(--lossBd); }
    .statDraw{ background:var(--drawBg); border-color:var(--drawBd); }

    .rightCol{
      display:flex;
      flex-direction:column;
      gap:10px;
      height:100%;
    }
    .chartBox{ flex: 2 1 auto; }
    .metaBoxRow{
      flex: 1 1 auto;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }

    .chartHead{ display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-bottom:8px; }
    .chartHead b{ font-size:13px; letter-spacing:.08em; text-transform:uppercase; opacity:.9; }
    .chartHead span{ font-size:12px; color:var(--muted); }
    #eloChart{ min-height:260px; color:var(--muted); }

    .sectionTitle{
      margin:18px 0 10px;
      font-size:16px;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-weight:950;
      opacity:.95;
    }

    /* Tournament table */
    .tblWrap{
      overflow-x:auto;
      border-radius:16px;
      -webkit-overflow-scrolling:touch;
    }
    .tbl{
      min-width:920px;
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--border2);
      border-radius:16px;
      background:var(--panel2);
      margin-bottom:12px;
    }
    .tbl th, .tbl td{
      padding:10px 10px;
      border-bottom:1px solid var(--border2);
      font-size:13px;
      vertical-align:top;
    }
    .tbl thead th{
      background:var(--thead);
      position:sticky;
      top:0;
      z-index:1;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-size:11px;
      opacity:.85;
    }
    .tbl tr:last-child td{ border-bottom:none; }
    .summaryRow td{
      font-weight:900;
      background: rgba(120,120,120,.10);
    }

    .bigError{
      display:flex; align-items:center; gap:12px;
      border:1px solid rgba(255,122,122,.35);
      background: rgba(255,122,122,.12);
      border-radius:18px;
      padding:14px;
      margin-top:10px;
      font-weight:900;
    }
    html[data-theme="dark"] .bigError{ color:#ffd0d0; }
    html[data-theme="light"] .bigError{ color:#7a1f1f; }
    .bigError .icon{ font-size:22px; }

    @media (max-width: 760px){
      .metaBoxRow{ grid-template-columns: 1fr 1fr; }
      .heroGrid{ grid-template-columns: 1fr; }
      .leftPanel{ min-height:auto; }
      .heroName{ font-size:30px; }
      .heroElo{ font-size:54px; }
    }

    @media (max-width: 560px){
      header{ padding:12px 12px 10px; }
      header .wrap{ flex-direction:column; gap:10px; }
      .logo{ width:76px; height:76px; flex-basis:76px; margin-top:0; }
      h1{ font-size:19px; margin-bottom:2px; }
      .subtitle{ margin-bottom:4px; font-size:11px; }
      .muted{ font-size:12px; line-height:1.25; }

      /* (2) mobile header: row1 = loaded + toggle, row2 = request button right */
      .headerRight{ width:100%; align-items:stretch; gap:8px; }
      .headerRightTop{
        width:100%;
        display:grid;
        grid-template-columns: 1fr auto; /* badge + toggle */
        gap:8px;
        align-items:center;
        justify-content:space-between;
      }
      .badge{ font-size:11px; padding:6px 8px; }
      .themeToggle{ font-size:11px; padding:6px 8px; }

      #requestUploadBtn{
        align-self:flex-end;
        justify-self:end;
        width:auto;
        padding:8px 10px;
        border-radius:12px;
        font-size:12px;
      }

      button{ padding:8px 10px; border-radius:12px; font-size:12px; }

      /* (3) info panels narrower */
      .container{ padding:0 12px; }
      .infoBar{
        grid-template-columns:1fr;
        gap:6px;
        padding:8px;
        border-radius:14px;
      }
      .infoItem{
        padding:6px 10px;
        min-height:38px;
        border-radius:12px;
      }
      .infoItem b{ font-size:10px; }
      .infoItem span{ font-size:13px; }

      main{ padding:12px; }

      /* Toolbar one row */
      .toolbar{
        flex-direction:row;
        align-items:center;
        gap:10px;
      }
      .left{
        width:100%;
        flex-wrap:nowrap;
        gap:8px;
      }
      #status{ flex:0 0 auto; }
      input[type="search"]{
        width:100%;
        padding:9px 10px;
        border-radius:12px;
        min-width:0;
      }
      .right{ flex:0 0 auto; }
      #refresh{ padding:9px 10px; border-radius:12px; }

      /* (1) Mobile standings table: show Rank + Player + Rating */
      .tableWrap{ overflow-x:hidden; }
      table{ table-layout:fixed; }
      th, td{ padding:10px 10px; }
      .colPeak, .colGames, .colWin, .colLoss, .colDraw, .colWinrate{ display:none !important; }

      .colRank{ width:58px; }
      .playerCol{ width:62%; }
      .ratingCol{ width:28%; }

      /* Modal full-screen on mobile (4) */
      .modalOverlay{ padding:0; }
      .modal{
        max-width:none;
        width:100vw;
        height:100vh;
        border-radius:0;
        border:none;
      }
      .modalBody{ padding:12px; }

      /* Player card: no horizontal scrolling except tables */
      .heroGrid{ grid-template-columns:1fr; }
      #eloChart{ min-height:180px; }
      .metaBoxRow{
        grid-template-columns:1fr;
        gap:8px;
      }
      .metaBoxRow .stat{
        min-height:42px;
        flex-direction:row;
        align-items:center;
        justify-content:space-between;
        padding:10px 12px;
      }
      .metaBoxRow .stat b{ font-size:11px; margin:0; }
      .metaBoxRow .stat span{ margin:0; font-size:14px; font-weight:950; text-align:right; }

      .tblWrap{ overflow-x:auto; }
      .tbl{ min-width:920px; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="headerLeft">
      <div class="logo">
        <img id="logoImg" src="logo.png" alt="Logo" />
      </div>
      <div>
        <h1>DC ELO ≈æeb≈ô√≠ƒçek</h1>
        <div class="subtitle">by Grail Series</div>
        <div class="muted">Data naƒç√≠t√°na z Google Sheets</div>
        <div class="credit muted">
          Za ve≈°ker√° data dƒõkujeme <b>Ervinovi Kuƒçovi</b>, kter√Ω data souƒçasnƒõ zpravuje.
        </div>
      </div>
    </div>

    <div class="headerRight">
      <div class="headerRightTop">
        <div class="badge" id="lastDataBadge">naƒçteno: naƒç√≠t√°m‚Ä¶</div>
        <div class="themeToggle" id="themeToggle" title="P≈ôepnout re≈æim">
          <span class="dot"></span>
          <span id="themeLabel">‚òÄÔ∏è Svƒõtl√Ω</span>
        </div>
      </div>
      <button class="btnPrimary" id="requestUploadBtn" type="button">ZA≈Ω√ÅDAT O NAHR√ÅN√ç DAT</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="infoBar" aria-label="Souhrn">
    <div class="infoItem"><b>pr≈Ømƒõrn√© ELO</b><span id="avgElo">‚Äî</span></div>
    <div class="infoItem"><b>pr≈Ømƒõrn√Ω winrate</b><span id="avgWinrate">‚Äî</span></div>
    <div class="infoItem"><b>celkov√Ω poƒçet her</b><span id="totalGames">‚Äî</span></div>
    <div class="infoItem"><b>posledn√≠ turnaj</b><span id="lastTournament">‚Äî</span></div>
  </div>
</div>

<main>
  <div class="card">
    <div class="toolbar">
      <div class="left">
        <span id="status" class="badge">Naƒç√≠t√°m‚Ä¶</span>
        <input id="search" type="search" placeholder="Hledat hr√°ƒçe‚Ä¶" autocomplete="off" />
      </div>
      <div class="right">
        <button id="refresh" type="button">Znovu naƒç√≠st</button>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="rank colRank">Po≈ôad√≠</th>
            <th class="playerCol">Player</th>
            <th class="num ratingCol">Rating</th>
            <th class="num colPeak">PEAK</th>
            <th class="num colGames">Games</th>
            <th class="num colWin">Win</th>
            <th class="num colLoss">Loss</th>
            <th class="num colDraw">Draw</th>
            <th class="num colWinrate">Winrate</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <footer>
      <span>Tip: Klikni na jm√©no hr√°ƒçe pro detail.</span>
      <span>verze: beta 0.9</span>
    </footer>
  </div>
</main>

<!-- Modal -->
<div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">
        <b id="modalName">Hr√°ƒç</b>
        <span id="modalSub">Detail hr√°ƒçe</span>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="closeModalBtn" class="btnDanger" type="button">Zav≈ô√≠t</button>
      </div>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
  const SHEET_ID = "1y98bzsIRpVv0_cGNfbITapucO5A6izeEz5lTM92ZbIA";
  const ELO_SHEET_NAME = "Elo standings";
  const DATA_SHEET_NAME = "Data";
  const PLAYER_CARDS_SHEET_NAME = "Player cards (CSV)";
  const PLAYER_SUMMARY_SHEET_NAME = "Player summary";

  const ELO_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(ELO_SHEET_NAME)}`;
  const DATA_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(DATA_SHEET_NAME)}`;
  const PLAYER_CARDS_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(PLAYER_CARDS_SHEET_NAME)}`;
  const PLAYER_SUMMARY_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(PLAYER_SUMMARY_SHEET_NAME)}`;

  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const searchEl = document.getElementById("search");
  const refreshBtn = document.getElementById("refresh");
  const lastDataBadge = document.getElementById("lastDataBadge");

  const avgEloEl = document.getElementById("avgElo");
  const avgWinrateEl = document.getElementById("avgWinrate");
  const totalGamesEl = document.getElementById("totalGames");
  const lastTournamentEl = document.getElementById("lastTournament");
  const requestUploadBtn = document.getElementById("requestUploadBtn");

  const modalOverlay = document.getElementById("modalOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const modalName = document.getElementById("modalName");
  const modalSub = document.getElementById("modalSub");
  const modalBody = document.getElementById("modalBody");

  const logoImg = document.getElementById("logoImg");

  /* THEME + LOGO swap */
  const htmlEl = document.documentElement;
  const themeToggle = document.getElementById("themeToggle");
  const themeLabel = document.getElementById("themeLabel");

  function syncLogo(){
    const theme = htmlEl.getAttribute("data-theme") || "dark";
    logoImg.src = (theme === "light") ? "logo2.png" : "logo.png";
  }
  function setTheme(theme){
    htmlEl.setAttribute("data-theme", theme);
    themeLabel.textContent = (theme === "dark") ? "‚òÄÔ∏è Svƒõtl√Ω" : "Tmav√Ω üåô";
    localStorage.setItem("theme", theme);
    syncLogo();
  }
  function initTheme(){
    const saved = localStorage.getItem("theme");
    if (saved === "light" || saved === "dark") setTheme(saved);
    else setTheme("dark");
  }
  themeToggle.addEventListener("click", () => {
    const cur = htmlEl.getAttribute("data-theme") || "dark";
    setTheme(cur === "dark" ? "light" : "dark");
  });
  initTheme();

  let allRows = [];
  let lastTournamentText = "";
  let playerCardsCache = null;
  let playerSummaryCache = null;

  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function normalizeKey(s){
    return (s || "").toString().trim().toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu,"");
  }
  function toNumber(x){
    if (x == null) return NaN;
    const s = x.toString().replace(/\s/g,"").replace(",",".");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }
  function safeInt(x){ return Number.isFinite(x) ? x.toFixed(0) : ""; }

  function formatNow(){
    return new Intl.DateTimeFormat("cs-CZ", {
      year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    }).format(new Date());
  }

  async function fetchUtf8Text(url){
    const res = await fetch(url, { cache: "no-store" });
    const buf = await res.arrayBuffer();
    const text = new TextDecoder("utf-8").decode(buf);
    return { res, text };
  }

  function parseCSV(csvText){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i=0;i<csvText.length;i++){
      const c = csvText[i];
      const next = csvText[i+1];
      if (c === '"' && inQuotes && next === '"'){ cur += '"'; i++; }
      else if (c === '"'){ inQuotes = !inQuotes; }
      else if (c === "," && !inQuotes){ row.push(cur); cur=""; }
      else if ((c === "\n" || c === "\r") && !inQuotes){
        if (c === "\r" && next === "\n") i++;
        row.push(cur); cur="";
        if (row.some(x => x.trim() !== "")) rows.push(row);
        row = [];
      } else cur += c;
    }
    if (cur.length || row.length){
      row.push(cur);
      if (row.some(x => x.trim() !== "")) rows.push(row);
    }
    return rows;
  }

  function rankCellHtml(rank){
    if (rank === 1) return `<span class="r1">üëë ${rank}</span>`;
    if (rank === 2) return `<span class="r2">${rank}</span>`;
    if (rank === 3) return `<span class="r3">${rank}</span>`;
    return `${rank}`;
  }

  function parseWinrateToNumber(winrateText){
    if (!winrateText) return NaN;
    const s = winrateText.toString().trim();
    if (!s) return NaN;
    if (s.includes("%")) return toNumber(s.replace("%",""));
    const n = toNumber(s);
    if (!Number.isFinite(n)) return NaN;
    if (n > 0 && n <= 1) return n * 100;
    return n;
  }

  function updateInfoBar(){
    const ratings = allRows.map(r => r.rating).filter(Number.isFinite).sort((a,b)=>a-b);
    const gamesArr = allRows.map(r => r.games).filter(Number.isFinite);
    const winrates = allRows.map(r => parseWinrateToNumber(r.winrate)).filter(Number.isFinite);

    let medianElo = NaN;
    if (ratings.length){
      const mid = Math.floor(ratings.length/2);
      medianElo = (ratings.length % 2) ? ratings[mid] : (ratings[mid-1]+ratings[mid])/2;
    }
    const totalGamesRaw = gamesArr.length ? gamesArr.reduce((a,b)=>a+b,0) : NaN;
    const totalGames = Number.isFinite(totalGamesRaw) ? (totalGamesRaw/2) : NaN;
    const avgWinrate = winrates.length ? (winrates.reduce((a,b)=>a+b,0)/winrates.length) : NaN;

    avgEloEl.textContent = Number.isFinite(medianElo) ? medianElo.toFixed(0) : "‚Äî";
    totalGamesEl.textContent = Number.isFinite(totalGames) ? totalGames.toFixed(0) : "‚Äî";
    avgWinrateEl.textContent = Number.isFinite(avgWinrate) ? `${avgWinrate.toFixed(0)}%` : "‚Äî";
    lastTournamentEl.textContent = lastTournamentText || "‚Äî";
  }

  async function loadLastData(){
    lastDataBadge.textContent = `naƒçteno: ${formatNow()}`;
    try{
      const u = new URL(DATA_CSV_URL);
      u.searchParams.set("_", Date.now().toString());
      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("HTML m√≠sto CSV");

      const rows = parseCSV(text);
      let last = "";
      for (let i=1;i<rows.length;i++){
        const v = (rows[i][1] ?? "").toString().trim();
        if (v) last = v;
      }
      lastTournamentText = last || "";
      updateInfoBar();
    } catch {
      lastTournamentText = "";
      updateInfoBar();
    }
  }

  function renderStandings(rows){
    const q = normalizeKey(searchEl.value);
    const filtered = rows.filter(r => !q || normalizeKey(r.player).includes(q)).sort((a,b)=>a.rank-b.rank);

    tbody.innerHTML = "";
    if (!filtered.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="9" class="muted">Nic nenalezeno.</td>`;
      tbody.appendChild(tr);
      return;
    }

    for (const r of filtered){
      const peakText = Number.isFinite(r.peak) ? r.peak.toFixed(0) : "";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="rank colRank">${rankCellHtml(r.rank)}</td>
        <td class="playerCol"><button class="playerBtn" type="button">${escapeHtml(r.player)}</button></td>
        <td class="num ratingCol">${Number.isFinite(r.rating) ? r.rating.toFixed(0) : ""}</td>
        <td class="num colPeak">${peakText}</td>
        <td class="num colGames">${safeInt(r.games)}</td>
        <td class="num colWin">${safeInt(r.win)}</td>
        <td class="num colLoss">${safeInt(r.loss)}</td>
        <td class="num colDraw">${safeInt(r.draw)}</td>
        <td class="num colWinrate">${escapeHtml(r.winrate || "")}</td>
      `;
      tr.querySelector(".playerBtn")._playerObj = r;
      tbody.appendChild(tr);
    }
  }

  async function loadStandings(){
    statusEl.textContent = "Naƒç√≠t√°m‚Ä¶";
    refreshBtn.disabled = true;
    try{
      const u = new URL(ELO_CSV_URL);
      u.searchParams.set("_", Date.now().toString());
      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("M√≠sto CSV p≈ôi≈°lo HTML.");

      const rows = parseCSV(text);

      const iPlayer = 0, iRating = 1, iGames=2, iWin=3, iLoss=4, iDraw=5, iWinrate=6, iPeak=7;

      const loaded = rows.slice(1).map(r => ({
        player:(r[iPlayer] ?? "").trim(),
        rating:toNumber(r[iRating]),
        peak:toNumber(r[iPeak]),
        games:toNumber(r[iGames]),
        win:toNumber(r[iWin]),
        loss:toNumber(r[iLoss]),
        draw:toNumber(r[iDraw]),
        winrate:(r[iWinrate] ?? "").toString().trim()
      })).filter(x=>x.player);

      loaded.sort((a,b)=>(b.rating||-Infinity)-(a.rating||-Infinity));
      allRows = loaded.map((p,i)=>({ ...p, rank:i+1 }));

      statusEl.textContent = `Naƒçteno: ${allRows.length}`;
      renderStandings(allRows);
      updateInfoBar();
    } finally {
      refreshBtn.disabled = false;
    }
  }

  async function loadPlayerCards(){
    if (playerCardsCache) return playerCardsCache;

    const u = new URL(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent("Player cards (CSV)")}`);
    u.searchParams.set("_", Date.now().toString());
    const { res, text } = await fetchUtf8Text(u.toString());
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    if (text.trim().startsWith("<")) throw new Error("HTML m√≠sto CSV");

    const rows = parseCSV(text);
    if (rows.length < 2) throw new Error("Player cards (CSV): pr√°zdn√© CSV");

    const items = rows.slice(1).map(r => ({
      player: (r[0] ?? "").toString().trim(),
      matchId: toNumber((r[1] ?? "").toString().trim()),
      tournament: (r[2] ?? "").toString().trim(),
      tournamentDetail: (r[3] ?? "").toString().trim(),
      date: (r[4] ?? "").toString().trim(),
      opponent: (r[5] ?? "").toString().trim(),
      result: (r[6] ?? "").toString().trim(),
      delta: (r[7] ?? "").toString().trim(),
      elo: toNumber((r[8] ?? "").toString().trim())
    })).filter(x => x.player);

    playerCardsCache = items;
    return items;
  }

  async function loadPlayerSummary(){
    if (playerSummaryCache) return playerSummaryCache;

    const u = new URL(PLAYER_SUMMARY_CSV_URL);
    u.searchParams.set("_", Date.now().toString());
    const { res, text } = await fetchUtf8Text(u.toString());
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    if (text.trim().startsWith("<")) throw new Error("HTML m√≠sto CSV");

    const rows = parseCSV(text);
    if (rows.length < 2) return [];

    const items = rows.slice(1).map(r => ({
      player: (r[0] ?? "").toString().trim(),
      avgOpp: toNumber((r[12] ?? "").toString().trim()),
      winStreak: toNumber((r[13] ?? "").toString().trim()),
      lossStreak: toNumber((r[14] ?? "").toString().trim())
    })).filter(x => x.player);

    playerSummaryCache = items;
    return items;
  }

  async function getSummaryForPlayer(playerName){
    const list = await loadPlayerSummary();
    const wanted = playerName.trim();
    return list.find(x => x.player.trim() === wanted) || null;
  }

  function buildSvgLineChartEqualX(points){
    const clean = points.filter(p => Number.isFinite(p.matchId) && Number.isFinite(p.elo)).slice();
    if (clean.length < 2) return `<div class="muted">Graf nelze vykreslit (m√°lo dat).</div>`;

    const w=980, h=280, padL=44, padR=18, padT=18, padB=42;
    const ys = clean.map(p=>p.elo);
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const spanY = Math.max(1, maxY - minY);

    const X = (i) => {
      const span = Math.max(1, clean.length - 1);
      return padL + (i*(w-padL-padR))/span;
    };
    const Y = v => (h-padB) - ((v-minY)*(h-padT-padB))/spanY;

    let d="";
    for (let i=0;i<clean.length;i++){
      d += (i===0 ? "M " : "L ") + X(i).toFixed(2) + " " + Y(clean[i].elo).toFixed(2) + " ";
    }

    const gridLines = 4;
    let grid = "";
    for (let i=0;i<=gridLines;i++){
      const t = i/gridLines;
      const yy = padT + t*(h-padT-padB);
      const val = Math.round(maxY - t*(maxY-minY));
      grid += `
        <line x1="${padL}" y1="${yy}" x2="${w-padR}" y2="${yy}" stroke="var(--chartGrid)" />
        <text x="${padL-10}" y="${yy+4}" text-anchor="end" fill="var(--chartText)" font-size="11">${val}</text>
      `;
    }

    const maxTicks = 8;
    const ticks = Math.min(maxTicks, clean.length);
    let xTicks = "";
    for (let i=0;i<ticks;i++){
      const idx = Math.round(i*(clean.length-1)/(ticks-1));
      const xx = X(idx);
      xTicks += `
        <line x1="${xx}" y1="${h-padB}" x2="${xx}" y2="${h-padB+6}" stroke="var(--chartAxis)" />
        <text x="${xx}" y="${h-padB+22}" text-anchor="middle" fill="var(--chartText)" font-size="11">${clean[idx].matchId}</text>
      `;
    }

    const dots = clean.map((p,i) => `<circle cx="${X(i)}" cy="${Y(p.elo)}" r="3.2" fill="var(--chartDot)" />`).join("");

    return `
      <svg viewBox="0 0 ${w} ${h}" width="100%" height="280" role="img" aria-label="ELO chart">
        ${grid}
        <line x1="${padL}" y1="${padT}" x2="${padL}" y2="${h-padB}" stroke="var(--chartAxis)" />
        <line x1="${padL}" y1="${h-padB}" x2="${w-padR}" y2="${h-padB}" stroke="var(--chartAxis)" />
        ${xTicks}
        <path d="${d}" fill="none" stroke="var(--chartLine)" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round" />
        ${dots}
        <text x="${padL}" y="${padT-4}" fill="var(--chartText)" font-size="11">ELO</text>
        <text x="${w-padR}" y="${h-10}" text-anchor="end" fill="var(--chartText)" font-size="11">Match ID</text>
      </svg>
    `;
  }

  function buildHero(playerObj, summary){
    const avgOpp = summary && Number.isFinite(summary.avgOpp) ? summary.avgOpp.toFixed(0) : "‚Äî";
    const winStreak = summary && Number.isFinite(summary.winStreak) ? summary.winStreak.toFixed(0) : "‚Äî";
    const lossStreak = summary && Number.isFinite(summary.lossStreak) ? summary.lossStreak.toFixed(0) : "‚Äî";
    const peakText = Number.isFinite(playerObj.peak) ? playerObj.peak.toFixed(0) : "‚Äî";

    return `
      <div class="heroGrid">
        <div class="box boxPad leftPanel">
          <div class="leftTop">
            <div class="heroName">${escapeHtml(playerObj.player)}</div>
            <div class="rankLine">
              <div class="muted">Po≈ôad√≠ v ≈æeb≈ô√≠ƒçku</div>
              <span class="rankPill">${rankCellHtml(playerObj.rank)}</span>
            </div>
            <div style="margin-top:10px;">
              <div class="heroEloLabel">aktu√°ln√≠ rating</div>
              <div class="heroElo">${Number.isFinite(playerObj.rating) ? playerObj.rating.toFixed(0) : ""}</div>
            </div>
          </div>

          <div class="leftBottom">
            <div class="statsGrid">
              <div class="stat"><b>games</b><span>${safeInt(playerObj.games)}</span></div>
              <div class="stat"><b>winrate</b><span>${escapeHtml(playerObj.winrate || "")}</span></div>
            </div>

            <div class="statsGridRow2">
              <div class="stat statWin"><b>win</b><span>${safeInt(playerObj.win)}</span></div>
              <div class="stat statLoss"><b>loss</b><span>${safeInt(playerObj.loss)}</span></div>
              <div class="stat statDraw"><b>draw</b><span>${safeInt(playerObj.draw)}</span></div>
            </div>
          </div>
        </div>

        <div class="rightCol">
          <div class="box boxPad chartBox">
            <div class="chartHead">
              <b>V√Ωvoj ELO</b>
              <span id="chartMeta" class="muted">Naƒç√≠t√°m data hr√°ƒçe‚Ä¶</span>
            </div>
            <div id="eloChart" class="muted">Naƒç√≠t√°m data hr√°ƒçe‚Ä¶</div>
          </div>

          <div class="metaBoxRow">
            <div class="stat"><b>peak elo</b><span>${peakText}</span></div>
            <div class="stat"><b>average opponent rating</b><span>${avgOpp}</span></div>
            <div class="stat statWin"><b>longest win streak</b><span>${winStreak} üî•</span></div>
            <div class="stat statLoss"><b>longest loss streak</b><span>${lossStreak}</span></div>
          </div>
        </div>
      </div>
    `;
  }

  function extractOpponentRating(opponentText){
    const t = (opponentText || "").toString().trim();
    const m = t.match(/\((\d+(?:[.,]\d+)?)\)\s*$/);
    if (!m) return NaN;
    return toNumber(m[1]);
  }

  function buildTournamentTable(rows){
    const w = rows.reduce((acc, r) => acc + ((r.result||"").toLowerCase().includes("won") ? 1 : 0), 0);
    const l = rows.reduce((acc, r) => acc + ((r.result||"").toLowerCase().includes("lost") ? 1 : 0), 0);
    const d = rows.reduce((acc, r) => acc + ((r.result||"").toLowerCase().includes("draw") ? 1 : 0), 0);

    const oppRatings = rows.map(r => extractOpponentRating(r.opponent)).filter(Number.isFinite);
    const avgOpp = oppRatings.length ? (oppRatings.reduce((a,b)=>a+b,0)/oppRatings.length) : NaN;

    const head = `
      <thead>
        <tr>
          <th class="num">Match ID</th>
          <th>Opponent (rating)</th>
          <th>Result</th>
          <th class="num">(+/-)</th>
          <th class="num">ELO</th>
          <th>Date</th>
          <th>Tournament</th>
        </tr>
      </thead>
    `;

    const body = rows.map(r => `
      <tr>
        <td class="num">${Number.isFinite(r.matchId) ? r.matchId.toFixed(0) : ""}</td>
        <td>${escapeHtml(r.opponent)}</td>
        <td>${escapeHtml(r.result)}</td>
        <td class="num">${escapeHtml(r.delta)}</td>
        <td class="num">${Number.isFinite(r.elo) ? r.elo.toFixed(0) : ""}</td>
        <td>${escapeHtml(r.date)}</td>
        <td>${escapeHtml(r.tournament)}</td>
      </tr>
    `).join("");

    const summaryRow = `
      <tr class="summaryRow">
        <td colspan="2">Souhrn</td>
        <td>Record: ${w}-${l}-${d}</td>
        <td colspan="2" class="num">Pr≈Ømƒõr ELO soupe≈ô≈Ø: ${Number.isFinite(avgOpp) ? avgOpp.toFixed(0) : "‚Äî"}</td>
        <td colspan="2"></td>
      </tr>
    `;

    return `<div class="tblWrap"><table class="tbl">${head}<tbody>${body}${summaryRow}</tbody></table></div>`;
  }

  async function loadPlayerDetail(playerObj){
    modalName.textContent = playerObj.player;
    modalSub.textContent = "Detail hr√°ƒçe";
    modalBody.innerHTML = `<div class="muted">Naƒç√≠t√°m‚Ä¶</div>`;
    modalOverlay.style.display = "block";
    document.body.style.overflow = "hidden";

    try{
      const [allCards, summary] = await Promise.all([loadPlayerCards(), getSummaryForPlayer(playerObj.player)]);
      const wanted = playerObj.player.trim();
      const cards = allCards.filter(r => r.player.trim() === wanted);

      if (!cards.length){
        modalBody.innerHTML = buildHero(playerObj, summary) +
          `<div class="bigError"><div class="icon">‚ùå</div> Podrobn√° data hr√°ƒçe nenalezena</div>`;
        return;
      }

      const sortedAll = cards.slice().sort((a,b) => (a.matchId||0) - (b.matchId||0));

      const groups = new Map();
      const order = [];
      for (const r of sortedAll){
        const key = (r.tournamentDetail || "Nezn√°m√©").trim();
        if (!groups.has(key)){ groups.set(key, []); order.push(key); }
        groups.get(key).push(r);
      }

      const sectionsHtml = order.map(key => {
        const rows = groups.get(key).slice().sort((a,b)=>(a.matchId||0)-(b.matchId||0));
        return `<div class="sectionTitle">${escapeHtml(key)}</div>${buildTournamentTable(rows)}`;
      }).join("");

      modalBody.innerHTML = buildHero(playerObj, summary) + sectionsHtml;

      const chartEl = document.getElementById("eloChart");
      const chartMeta = document.getElementById("chartMeta");

      const points = sortedAll
        .filter(r => Number.isFinite(r.matchId) && Number.isFinite(r.elo))
        .map(r => ({ matchId:r.matchId, elo:r.elo }));

      chartEl.innerHTML = buildSvgLineChartEqualX(points);

      if (points.length){
        const last = points[points.length - 1];
        chartMeta.textContent = `z√°pas≈Ø: ${points.length} ‚Ä¢ posledn√≠ Match ID: ${last.matchId.toFixed(0)} ‚Ä¢ posledn√≠ ELO: ${last.elo.toFixed(0)}`;
      } else {
        chartMeta.textContent = "Nelze vykreslit (chyb√≠ Match ID/ELO)";
        chartEl.innerHTML = `<div class="muted">Graf nelze vykreslit (chyb√≠ Match ID/ELO v datech hr√°ƒçe).</div>`;
      }

    } catch (e){
      modalBody.innerHTML = `<div class="bigError"><div class="icon">‚ùå</div> Chyba p≈ôi naƒç√≠t√°n√≠: ${escapeHtml(String(e?.message || e))}</div>`;
    }
  }

  async function loadAll(){
    await Promise.all([loadStandings(), loadLastData()]);
    playerCardsCache = null;
    playerSummaryCache = null;
  }

  requestUploadBtn.addEventListener("click", () => {
    window.location.href = "https://forms.gle/Y7aHApF5NLFLw6MP9";
  });
  refreshBtn.addEventListener("click", loadAll);
  searchEl.addEventListener("input", () => renderStandings(allRows));

  tbody.addEventListener("click", (e) => {
    const btn = e.target.closest(".playerBtn");
    if (!btn) return;
    loadPlayerDetail(btn._playerObj);
  });

  closeModalBtn.addEventListener("click", () => {
    modalOverlay.style.display="none";
    document.body.style.overflow="";
    modalBody.innerHTML="";
  });
  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay){
      modalOverlay.style.display="none";
      document.body.style.overflow="";
      modalBody.innerHTML="";
    }
  });
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modalOverlay.style.display === "block"){
      modalOverlay.style.display="none";
      document.body.style.overflow="";
      modalBody.innerHTML="";
    }
  });

  loadAll();
</script>
</body>
</html>
