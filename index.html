<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ELO ≈æeb≈ô√≠ƒçek</title>

  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(900px 500px at 80% 0%, rgba(255,215,0,.08), transparent 60%),
                  #0f1115;
      color: #eef2ff;
    }

    a { color: inherit; }

    header {
      padding: 18px 18px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(15,17,21,.6);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    header .wrap {
      max-width: 1150px;
      margin: 0 auto;
      display: flex;
      gap: 16px;
      align-items: flex-start;
      justify-content: space-between;
    }

    h1 { margin: 0 0 6px; font-size: 26px; letter-spacing: .2px; }
    .muted { opacity: .78; }
    .credit { margin-top: 6px; }

    main { max-width: 1150px; margin: 0 auto; padding: 16px; }

    .card {
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      overflow: hidden;
      background: rgba(255,255,255,.035);
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
    }

    .toolbar {
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: space-between;
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }

    .left { display:flex; gap: 12px; align-items:center; flex-wrap: wrap; }
    .right { display:flex; gap: 10px; align-items:center; }

    .badge {
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      white-space: nowrap;
    }

    input[type="search"]{
      width: min(380px, 70vw);
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: inherit;
      outline: none;
    }
    input[type="search"]:focus{
      border-color: rgba(255,255,255,.28);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }

    button{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: inherit;
      cursor: pointer;
      white-space: nowrap;
    }
    button:hover { background: rgba(255,255,255,.06); }
    button:disabled { opacity: .6; cursor: not-allowed; }

    .tableWrap { overflow:auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(15,17,21,.92);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,.12);
      font-size: 12px;
      letter-spacing: .08em;
      text-transform: uppercase;
      opacity: .85;
    }

    th, td { text-align: left; padding: 12px 12px; }
    tbody tr { border-top: 1px solid rgba(255,255,255,.06); }
    tbody tr:nth-child(2n) { background: rgba(255,255,255,.02); }
    tbody tr:hover { background: rgba(255,255,255,.055); }

    .num { text-align: right; font-variant-numeric: tabular-nums; }
    .rank { width: 90px; font-variant-numeric: tabular-nums; }
    .playerBtn {
      border: none;
      background: none;
      color: inherit;
      cursor: pointer;
      padding: 0;
      font: inherit;
      text-decoration: underline;
      text-decoration-color: rgba(255,255,255,.25);
      text-underline-offset: 3px;
    }
    .playerBtn:hover { text-decoration-color: rgba(255,255,255,.6); }

    .r1 { color: #ffd54a; font-weight: 800; }
    .r2 { color: #d6dbe6; font-weight: 800; }
    .r3 { color: #d29a6a; font-weight: 800; }

    #error { display:none; margin-top: 12px; white-space: pre-wrap; color: #ff7a7a; }

    footer {
      padding: 12px;
      opacity: .75;
      font-size: 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }

    /* Modal */
    .modalOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(6px);
      z-index: 50;
      padding: 18px;
    }
    .modal {
      max-width: 1100px;
      margin: 0 auto;
      height: calc(100vh - 36px);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(15,17,21,.92);
      box-shadow: 0 30px 90px rgba(0,0,0,.6);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
    }
    .modalTitle{
      display:flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .modalTitle b{
      font-size: 16px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70vw;
    }
    .modalTitle span{
      font-size: 12px;
      opacity: .75;
    }
    .modalBody{
      padding: 10px 12px 14px;
      overflow: auto;
    }
    .gridTable{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      overflow: hidden;
      background: rgba(255,255,255,.02);
    }
    .gridTable td{
      border-top: 1px solid rgba(255,255,255,.08);
      border-right: 1px solid rgba(255,255,255,.08);
      padding: 8px 10px;
      vertical-align: top;
      white-space: pre-wrap;
    }
    .gridTable tr:first-child td { border-top: none; }
    .gridTable td:last-child { border-right: none; }
    .gridTable tr:nth-child(2n) td { background: rgba(255,255,255,.02); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(15,17,21,.95);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
      display:none;
      z-index: 60;
      max-width: min(680px, calc(100vw - 36px));
    }

    @media (max-width: 740px) {
      header .wrap { flex-direction: column; }
      .right { width: 100%; justify-content: space-between; }
      .rank { width: 80px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div>
        <h1>ELO ≈æeb≈ô√≠ƒçek</h1>
        <div class="muted">Naƒç√≠t√°no z Google Sheets (list: ‚ÄúElo standings‚Äù).</div>
        <div class="credit muted">
          Za ve≈°ker√° data dƒõkujeme <b>Ervinovi Kuƒçovi</b>, kter√Ω data souƒçasnƒõ zpravuje:
        </div>
      </div>

      <div class="badge" id="lastDataBadge">posledn√≠ data: naƒç√≠t√°m‚Ä¶</div>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="toolbar">
        <div class="left">
          <span id="status" class="badge">Naƒç√≠t√°m‚Ä¶</span>
          <input id="search" type="search" placeholder="Hledat hr√°ƒçe‚Ä¶" autocomplete="off" />
        </div>

        <div class="right">
          <button id="refresh" type="button">Znovu naƒç√≠st</button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th class="rank">Po≈ôad√≠</th>
              <th>Player</th>
              <th class="num">Rating</th>
              <th class="num">Games</th>
              <th class="num">Win</th>
              <th class="num">Loss</th>
              <th class="num">Draw</th>
              <th class="num">Winrate</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <footer>
        Tip: Klikni na jm√©no hr√°ƒçe pro detail (list se stejn√Ωm n√°zvem). Po≈ôad√≠ je ‚Äûlocknut√©‚Äú po naƒçten√≠ dat.
      </footer>
    </div>

    <div id="error"></div>
  </main>

  <!-- Modal -->
  <div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle">
          <b id="modalName">Hr√°ƒç</b>
          <span id="modalSub">Naƒç√≠t√°m‚Ä¶</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button id="openSheetTabBtn" type="button" title="Otev≈ô√≠t Google Sheet dokument">Otev≈ô√≠t Sheets</button>
          <button id="closeModalBtn" type="button">Zav≈ô√≠t</button>
        </div>
      </div>
      <div class="modalBody" id="modalBody">
        <!-- grid -->
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  // --- ZDROJOV√ù SHEET ---
  const SHEET_ID = "1y98bzsIRpVv0_cGNfbITapucO5A6izeEz5lTM92ZbIA";
  const ELO_SHEET_NAME = "Elo standings";
  const DATA_SHEET_NAME = "Data";

  const ELO_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(ELO_SHEET_NAME)}`;

  const DATA_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(DATA_SHEET_NAME)}`;

  // --- DOM ---
  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const errorEl = document.getElementById("error");
  const searchEl = document.getElementById("search");
  const refreshBtn = document.getElementById("refresh");
  const lastDataBadge = document.getElementById("lastDataBadge");

  const modalOverlay = document.getElementById("modalOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const openSheetTabBtn = document.getElementById("openSheetTabBtn");
  const modalName = document.getElementById("modalName");
  const modalSub = document.getElementById("modalSub");
  const modalBody = document.getElementById("modalBody");

  const toastEl = document.getElementById("toast");

  let allRows = [];

  // --- Helpers ---
  function setStatus(text) { statusEl.textContent = text; }
  function showError(msg) { errorEl.style.display = "block"; errorEl.textContent = msg; }
  function hideError() { errorEl.style.display = "none"; errorEl.textContent = ""; }

  function toast(msg) {
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(() => toastEl.style.display = "none", 2600);
  }

  function escapeHtml(str) {
    return (str ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function normalizeKey(s) {
    return (s || "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu, "");
  }

  // CSV parser s podporou uvozovek
  function parseCSV(csvText) {
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < csvText.length; i++) {
      const c = csvText[i];
      const next = csvText[i + 1];

      if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; }
      else if (c === '"') inQuotes = !inQuotes;
      else if (c === "," && !inQuotes) { row.push(cur); cur = ""; }
      else if ((c === "\n" || c === "\r") && !inQuotes) {
        if (c === "\r" && next === "\n") i++;
        row.push(cur); cur = "";
        if (row.some(x => x.trim() !== "")) rows.push(row);
        row = [];
      } else {
        cur += c;
      }
    }

    if (cur.length || row.length) {
      row.push(cur);
      if (row.some(x => x.trim() !== "")) rows.push(row);
    }

    return rows;
  }

  function toNumber(x) {
    if (x == null) return NaN;
    const s = x.toString().replace(/\s/g, "").replace(",", ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  async function fetchUtf8Text(url) {
    const res = await fetch(url, { cache: "no-store" });
    const buf = await res.arrayBuffer();
    const text = new TextDecoder("utf-8").decode(buf);
    return { res, text };
  }

  function rankCellHtml(rank) {
    if (rank === 1) return `<span class="r1">üëë ${rank}</span>`;
    if (rank === 2) return `<span class="r2">${rank}</span>`;
    if (rank === 3) return `<span class="r3">${rank}</span>`;
    return `${rank}`;
  }

  function render(rows) {
    const q = normalizeKey(searchEl.value);

    // filtrujeme, ale rank nech√°v√°me "locknut√Ω"
    const filtered = rows.filter(r => !q || normalizeKey(r.player).includes(q));
    filtered.sort((a, b) => a.rank - b.rank);

    tbody.innerHTML = "";

    if (!filtered.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" class="muted">Nic nenalezeno.</td>`;
      tbody.appendChild(tr);
      return;
    }

    for (const r of filtered) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="rank">${rankCellHtml(r.rank)}</td>
        <td>
          <button class="playerBtn" data-player="${escapeHtml(r.player)}" type="button">
            ${escapeHtml(r.player)}
          </button>
        </td>
        <td class="num">${Number.isFinite(r.rating) ? r.rating.toFixed(0) : ""}</td>
        <td class="num">${Number.isFinite(r.games) ? r.games.toFixed(0) : ""}</td>
        <td class="num">${Number.isFinite(r.win) ? r.win.toFixed(0) : ""}</td>
        <td class="num">${Number.isFinite(r.loss) ? r.loss.toFixed(0) : ""}</td>
        <td class="num">${Number.isFinite(r.draw) ? r.draw.toFixed(0) : ""}</td>
        <td class="num">${escapeHtml(r.winrate || "")}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // --- "posledn√≠ data" z listu Data, sloupec B ---
  async function loadLastData() {
    try {
      const u = new URL(DATA_CSV_URL);
      u.searchParams.set("_", Date.now().toString());

      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("HTML m√≠sto CSV");

      const rows = parseCSV(text);
      if (rows.length < 2) {
        lastDataBadge.textContent = "posledn√≠ data: (nenalezeno)";
        return;
      }

      let last = "";
      for (let i = 1; i < rows.length; i++) {
        const val = (rows[i][1] ?? "").toString().trim(); // sloupec B
        if (val) last = val;
      }
      lastDataBadge.textContent = `posledn√≠ data: ${last || "(nenalezeno)"}`;
    } catch {
      lastDataBadge.textContent = "posledn√≠ data: chyba";
    }
  }

  // --- standings ---
  async function loadStandings() {
    hideError();
    setStatus("Naƒç√≠t√°m‚Ä¶");
    refreshBtn.disabled = true;

    try {
      const u = new URL(ELO_CSV_URL);
      u.searchParams.set("_", Date.now().toString());

      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("M√≠sto CSV p≈ôi≈°lo HTML (sheet nen√≠ ve≈ôejn√Ω / nen√≠ publikovan√Ω).");

      const rows = parseCSV(text);
      if (!rows.length) throw new Error("Pr√°zdn√© CSV.");

      const headers = rows[0].map(h => normalizeKey(h));
      const idx = (name) => headers.indexOf(name);

      const iPlayer  = idx("player");
      const iRating  = idx("rating");
      const iGames   = idx("games");
      const iWin     = idx("win");
      const iLoss    = idx("loss");
      const iDraw    = idx("draw");
      const iWinrate = headers.findIndex(h => h === "winrate" || h.includes("winrate"));

      if ([iPlayer, iRating, iGames, iWin, iLoss, iDraw].some(i => i === -1) || iWinrate === -1) {
        throw new Error(
          "Nena≈°el jsem v≈°echny po≈æadovan√© sloupce A‚ÄìG (player, rating, games, win, loss, draw, winrate).\n" +
          `Hlaviƒçky v CSV: ${headers.join(", ")}`
        );
      }

      const loaded = rows.slice(1)
        .map(r => ({
          player:  (r[iPlayer] ?? "").trim(),
          rating:  toNumber(r[iRating]),
          games:   toNumber(r[iGames]),
          win:     toNumber(r[iWin]),
          loss:    toNumber(r[iLoss]),
          draw:    toNumber(r[iDraw]),
          winrate: (r[iWinrate] ?? "").toString().trim()
        }))
        .filter(x => x.player.length > 0);

      // ≈Ωeb≈ô√≠ƒçek podle ratingu
      loaded.sort((a, b) => (b.rating || -Infinity) - (a.rating || -Infinity));

      // LOCK po≈ôad√≠
      allRows = loaded.map((p, i) => ({ ...p, rank: i + 1 }));

      setStatus(`Naƒçteno: ${allRows.length}`);
      render(allRows);
    } catch (e) {
      setStatus("Chyba");
      showError(String(e?.message || e));
    } finally {
      refreshBtn.disabled = false;
    }
  }

  async function loadAll() {
    await Promise.all([loadStandings(), loadLastData()]);
  }

  // --- Player detail modal ---
  function openModal() {
    modalOverlay.style.display = "block";
    document.body.style.overflow = "hidden";
  }
  function closeModal() {
    modalOverlay.style.display = "none";
    document.body.style.overflow = "";
    modalBody.innerHTML = "";
  }

  function buildGridTable(rows) {
    // o≈ô√≠zneme trailing pr√°zdn√© sloupce, a nech√°me rozumn√Ω poƒçet
    const trimmed = rows
      .map(r => {
        let lastNonEmpty = -1;
        for (let i = 0; i < r.length; i++) {
          if ((r[i] ?? "").toString().trim() !== "") lastNonEmpty = i;
        }
        return r.slice(0, Math.max(0, lastNonEmpty + 1));
      })
      .filter(r => r.some(cell => (cell ?? "").toString().trim() !== ""));

    if (!trimmed.length) return `<div class="muted">≈Ω√°dn√° data.</div>`;

    const maxCols = Math.min(12, Math.max(...trimmed.map(r => r.length)));
    const htmlRows = trimmed.map(r => {
      const cells = [];
      for (let i = 0; i < maxCols; i++) {
        const v = (r[i] ?? "").toString();
        cells.push(`<td>${escapeHtml(v)}</td>`);
      }
      return `<tr>${cells.join("")}</tr>`;
    });

    return `<table class="gridTable">${htmlRows.join("")}</table>`;
  }

  async function loadPlayerSheet(playerName) {
    // list se jmenuje stejnƒõ jako hr√°ƒç
    const url =
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(playerName)}`;

    modalName.textContent = playerName;
    modalSub.textContent = "Naƒç√≠t√°m detail‚Ä¶";
    modalBody.innerHTML = `<div class="muted">Naƒç√≠t√°m‚Ä¶</div>`;
    openModal();

    // tlaƒç√≠tko otev≈ô√≠t cel√Ω dokument (tab konkr√©tn√≠ neum√≠me bez gid)
    openSheetTabBtn.onclick = () => {
      window.open(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`, "_blank", "noopener,noreferrer");
    };

    try {
      const u = new URL(url);
      u.searchParams.set("_", Date.now().toString());

      const { res, text } = await fetchUtf8Text(u.toString());

      // Neexistuj√≠c√≠ sheet ƒçasto vr√°t√≠ HTML nebo pr√°zdno
      if (!res.ok) throw new Error("HTTP");
      if (text.trim().startsWith("<")) throw new Error("HTML");

      const rows = parseCSV(text);
      if (!rows.length) throw new Error("EMPTY");

      modalSub.textContent = "Detail z listu se stejn√Ωm n√°zvem";
      modalBody.innerHTML = buildGridTable(rows);
    } catch {
      closeModal();
      toast("Podrobn√° data hr√°ƒçe nenalezena");
    }
  }

  // --- events ---
  searchEl.addEventListener("input", () => render(allRows));
  refreshBtn.addEventListener("click", loadAll);

  tbody.addEventListener("click", (e) => {
    const btn = e.target.closest(".playerBtn");
    if (!btn) return;
    const player = btn.getAttribute("data-player");
    if (!player) return;
    loadPlayerSheet(player);
  });

  closeModalBtn.addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) closeModal();
  });
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modalOverlay.style.display === "block") closeModal();
  });

  loadAll();
</script>
</body>
</html>
