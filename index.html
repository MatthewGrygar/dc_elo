<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ELO ≈æeb≈ô√≠ƒçek</title>

  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(900px 500px at 80% 0%, rgba(255,215,0,.08), transparent 60%),
                  #0f1115;
      color: #eef2ff;
    }

    header {
      padding: 18px 18px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(15,17,21,.6);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    header .wrap {
      max-width: 1150px;
      margin: 0 auto;
      display: flex;
      gap: 16px;
      align-items: flex-start;
      justify-content: space-between;
    }

    h1 { margin: 0 0 6px; font-size: 26px; letter-spacing: .2px; }
    .muted { opacity: .78; }
    .credit { margin-top: 6px; }

    main { max-width: 1150px; margin: 0 auto; padding: 16px; }

    .card {
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      overflow: hidden;
      background: rgba(255,255,255,.035);
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
    }

    .toolbar {
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: space-between;
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }

    .left { display:flex; gap: 12px; align-items:center; flex-wrap: wrap; }
    .right { display:flex; gap: 10px; align-items:center; }

    .badge {
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      white-space: nowrap;
    }

    input[type="search"]{
      width: min(380px, 70vw);
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: inherit;
      outline: none;
    }
    input[type="search"]:focus{
      border-color: rgba(255,255,255,.28);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }

    button{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: inherit;
      cursor: pointer;
      white-space: nowrap;
    }
    button:hover { background: rgba(255,255,255,.06); }
    button:disabled { opacity: .6; cursor: not-allowed; }

    .tableWrap { overflow:auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(15,17,21,.92);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,.12);
      font-size: 12px;
      letter-spacing: .08em;
      text-transform: uppercase;
      opacity: .85;
    }

    th, td { text-align: left; padding: 12px 12px; }
    tbody tr:nth-child(2n) { background: rgba(255,255,255,.02); }
    tbody tr:hover { background: rgba(255,255,255,.055); }

    .num { text-align: right; font-variant-numeric: tabular-nums; }
    .rank { width: 90px; font-variant-numeric: tabular-nums; }
    .playerBtn {
      border: none;
      background: none;
      color: inherit;
      cursor: pointer;
      padding: 0;
      font: inherit;
      text-decoration: underline;
      text-decoration-color: rgba(255,255,255,.25);
      text-underline-offset: 3px;
    }
    .playerBtn:hover { text-decoration-color: rgba(255,255,255,.6); }

    .r1 { color: #ffd54a; font-weight: 900; }
    .r2 { color: #d6dbe6; font-weight: 900; }
    .r3 { color: #d29a6a; font-weight: 900; }

    #error { display:none; margin-top: 12px; white-space: pre-wrap; color: #ff7a7a; }

    footer {
      padding: 12px;
      opacity: .75;
      font-size: 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }

    /* Modal */
    .modalOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(6px);
      z-index: 50;
      padding: 18px;
    }
    .modal {
      max-width: 1100px;
      margin: 0 auto;
      height: calc(100vh - 36px);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(15,17,21,.92);
      box-shadow: 0 30px 90px rgba(0,0,0,.6);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
    }
    .modalTitle{
      display:flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .modalTitle b{
      font-size: 16px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70vw;
    }
    .modalTitle span{
      font-size: 12px;
      opacity: .75;
    }

    .modalBody{
      padding: 12px;
      overflow: auto;
    }

    .playerHero{
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    .heroCard{
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 14px;
      background: rgba(255,255,255,.03);
    }
    .heroTop{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
    }
    .heroName{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
      margin: 0 0 6px;
    }
    .heroElo{
      font-size: 42px;
      font-weight: 900;
      line-height: 1;
      margin: 0;
    }
    .heroRank{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      margin-top: 10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      white-space: nowrap;
    }

    .statsRow{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .stat{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding: 10px 10px;
    }
    .stat b{ display:block; font-size: 12px; opacity:.75; letter-spacing:.06em; text-transform: uppercase; }
    .stat span{ display:block; margin-top: 4px; font-size: 16px; font-weight: 800; }

    .sectionTitle{
      margin: 18px 0 10px;
      font-size: 14px;
      letter-spacing: .06em;
      text-transform: uppercase;
      opacity: .85;
    }

    .miniTableWrap{ overflow:auto; border: 1px solid rgba(255,255,255,.10); border-radius: 16px; }
    .miniTable{ width:100%; border-collapse: separate; border-spacing:0; }
    .miniTable th, .miniTable td { padding: 10px 10px; border-top: 1px solid rgba(255,255,255,.08); }
    .miniTable thead th { position: sticky; top: 0; background: rgba(15,17,21,.96); border-top: none; }
    .miniTable tbody tr:nth-child(2n) { background: rgba(255,255,255,.02); }
    .miniTable .num { text-align:right; }

    .chartCard{
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 12px;
      background: rgba(255,255,255,.03);
    }

    .bigError{
      display:flex;
      align-items:center;
      gap: 12px;
      border: 1px solid rgba(255,122,122,.35);
      background: rgba(255,122,122,.08);
      color: #ffd0d0;
      border-radius: 18px;
      padding: 14px;
      margin-top: 10px;
      font-weight: 800;
    }
    .bigError .icon{ font-size: 22px; }

    @media (max-width: 860px) {
      .playerHero { grid-template-columns: 1fr; }
      .statsRow { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div>
        <h1>ELO ≈æeb≈ô√≠ƒçek</h1>
        <div class="muted">Naƒç√≠t√°no z Google Sheets (list: ‚ÄúElo standings‚Äù).</div>
        <div class="credit muted">
          Za ve≈°ker√° data dƒõkujeme <b>Ervinovi Kuƒçovi</b>, kter√Ω data souƒçasnƒõ zpravuje:
        </div>
      </div>

      <div class="badge" id="lastDataBadge">posledn√≠ data: naƒç√≠t√°m‚Ä¶</div>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="toolbar">
        <div class="left">
          <span id="status" class="badge">Naƒç√≠t√°m‚Ä¶</span>
          <input id="search" type="search" placeholder="Hledat hr√°ƒçe‚Ä¶" autocomplete="off" />
        </div>

        <div class="right">
          <button id="refresh" type="button">Znovu naƒç√≠st</button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th class="rank">Po≈ôad√≠</th>
              <th>Player</th>
              <th class="num">Rating</th>
              <th class="num">Games</th>
              <th class="num">Win</th>
              <th class="num">Loss</th>
              <th class="num">Draw</th>
              <th class="num">Winrate</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <footer>
        Tip: Klikni na jm√©no hr√°ƒçe pro detail (list se stejn√Ωm n√°zvem). Po≈ôad√≠ je ‚Äûlocknut√©‚Äú po naƒçten√≠ dat.
      </footer>
    </div>

    <div id="error"></div>
  </main>

  <!-- Modal -->
  <div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle">
          <b id="modalName">Hr√°ƒç</b>
          <span id="modalSub">Naƒç√≠t√°m‚Ä¶</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button id="openSheetTabBtn" type="button" title="Otev≈ô√≠t Google Sheet dokument">Otev≈ô√≠t Sheets</button>
          <button id="closeModalBtn" type="button">Zav≈ô√≠t</button>
        </div>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

<script>
  const SHEET_ID = "1y98bzsIRpVv0_cGNfbITapucO5A6izeEz5lTM92ZbIA";
  const ELO_SHEET_NAME = "Elo standings";
  const DATA_SHEET_NAME = "Data";

  const ELO_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(ELO_SHEET_NAME)}`;
  const DATA_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(DATA_SHEET_NAME)}`;

  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const errorEl = document.getElementById("error");
  const searchEl = document.getElementById("search");
  const refreshBtn = document.getElementById("refresh");
  const lastDataBadge = document.getElementById("lastDataBadge");

  const modalOverlay = document.getElementById("modalOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const openSheetTabBtn = document.getElementById("openSheetTabBtn");
  const modalName = document.getElementById("modalName");
  const modalSub = document.getElementById("modalSub");
  const modalBody = document.getElementById("modalBody");

  let allRows = [];

  function setStatus(text) { statusEl.textContent = text; }
  function showError(msg) { errorEl.style.display = "block"; errorEl.textContent = msg; }
  function hideError() { errorEl.style.display = "none"; errorEl.textContent = ""; }

  function escapeHtml(str) {
    return (str ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function normalizeKey(s) {
    return (s || "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu, "");
  }

  function parseCSV(csvText) {
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < csvText.length; i++) {
      const c = csvText[i];
      const next = csvText[i + 1];

      if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; }
      else if (c === '"') inQuotes = !inQuotes;
      else if (c === "," && !inQuotes) { row.push(cur); cur = ""; }
      else if ((c === "\n" || c === "\r") && !inQuotes) {
        if (c === "\r" && next === "\n") i++;
        row.push(cur); cur = "";
        if (row.some(x => x.trim() !== "")) rows.push(row);
        row = [];
      } else {
        cur += c;
      }
    }
    if (cur.length || row.length) {
      row.push(cur);
      if (row.some(x => x.trim() !== "")) rows.push(row);
    }
    return rows;
  }

  function toNumber(x) {
    if (x == null) return NaN;
    const s = x.toString().replace(/\s/g, "").replace(",", ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  async function fetchUtf8Text(url) {
    const res = await fetch(url, { cache: "no-store" });
    const buf = await res.arrayBuffer();
    const text = new TextDecoder("utf-8").decode(buf);
    return { res, text };
  }

  function rankCellHtml(rank) {
    if (rank === 1) return `<span class="r1">üëë ${rank}</span>`;
    if (rank === 2) return `<span class="r2">${rank}</span>`;
    if (rank === 3) return `<span class="r3">${rank}</span>`;
    return `${rank}`;
  }

  function openModal() {
    modalOverlay.style.display = "block";
    document.body.style.overflow = "hidden";
  }
  function closeModal() {
    modalOverlay.style.display = "none";
    document.body.style.overflow = "";
    modalBody.innerHTML = "";
  }

  function buildHero(playerObj) {
    const elo = Number.isFinite(playerObj.rating) ? playerObj.rating.toFixed(0) : "";
    return `
      <div class="playerHero">
        <div class="heroCard">
          <div class="heroTop">
            <div style="min-width:0;">
              <div class="heroName">${escapeHtml(playerObj.player)}</div>
              <div class="muted">Po≈ôad√≠ v ≈æeb≈ô√≠ƒçku</div>
              <div class="heroRank">
                <span class="chip">${rankCellHtml(playerObj.rank)}</span>
                <span class="chip">ELO</span>
              </div>
            </div>
            <div style="text-align:right;">
              <div class="muted">aktu√°ln√≠ rating</div>
              <div class="heroElo">${escapeHtml(elo)}</div>
            </div>
          </div>

          <div class="statsRow">
            <div class="stat"><b>games</b><span>${safeInt(playerObj.games)}</span></div>
            <div class="stat"><b>win</b><span>${safeInt(playerObj.win)}</span></div>
            <div class="stat"><b>loss</b><span>${safeInt(playerObj.loss)}</span></div>
            <div class="stat"><b>draw</b><span>${safeInt(playerObj.draw)}</span></div>
            <div class="stat"><b>winrate</b><span>${escapeHtml(playerObj.winrate || "")}</span></div>
          </div>
        </div>

        <div class="chartCard" id="chartCard">
          <div class="muted" style="margin-bottom:8px;">V√Ωvoj ELO</div>
          <div id="eloChart" class="muted">Naƒç√≠t√°m data hr√°ƒçe‚Ä¶</div>
        </div>
      </div>
    `;
  }

  function safeInt(x) {
    return Number.isFinite(x) ? x.toFixed(0) : "";
  }

  function render(rows) {
    const q = normalizeKey(searchEl.value);
    const filtered = rows.filter(r => !q || normalizeKey(r.player).includes(q));
    filtered.sort((a, b) => a.rank - b.rank);

    tbody.innerHTML = "";

    if (!filtered.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" class="muted">Nic nenalezeno.</td>`;
      tbody.appendChild(tr);
      return;
    }

    filtered.forEach((r, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="rank">${rankCellHtml(r.rank)}</td>
        <td>
          <button class="playerBtn" data-index="${idx}" type="button">
            ${escapeHtml(r.player)}
          </button>
        </td>
        <td class="num">${Number.isFinite(r.rating) ? r.rating.toFixed(0) : ""}</td>
        <td class="num">${safeInt(r.games)}</td>
        <td class="num">${safeInt(r.win)}</td>
        <td class="num">${safeInt(r.loss)}</td>
        <td class="num">${safeInt(r.draw)}</td>
        <td class="num">${escapeHtml(r.winrate || "")}</td>
      `;
      // ulo≈æ√≠me referenci p≈ô√≠mo na objekt (nebudeme ≈ôe≈°it index p≈ôes filtrovan√© pole)
      tr.querySelector(".playerBtn")._playerObj = r;
      tbody.appendChild(tr);
    });
  }

  async function loadLastData() {
    try {
      const u = new URL(DATA_CSV_URL);
      u.searchParams.set("_", Date.now().toString());

      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("HTML m√≠sto CSV");

      const rows = parseCSV(text);
      if (rows.length < 2) {
        lastDataBadge.textContent = "posledn√≠ data: (nenalezeno)";
        return;
      }

      let last = "";
      for (let i = 1; i < rows.length; i++) {
        const val = (rows[i][1] ?? "").toString().trim(); // sloupec B
        if (val) last = val;
      }
      lastDataBadge.textContent = `posledn√≠ data: ${last || "(nenalezeno)"}`;
    } catch {
      lastDataBadge.textContent = "posledn√≠ data: chyba";
    }
  }

  async function loadStandings() {
    hideError();
    setStatus("Naƒç√≠t√°m‚Ä¶");
    refreshBtn.disabled = true;

    try {
      const u = new URL(ELO_CSV_URL);
      u.searchParams.set("_", Date.now().toString());

      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("M√≠sto CSV p≈ôi≈°lo HTML (sheet nen√≠ ve≈ôejn√Ω / nen√≠ publikovan√Ω).");

      const rows = parseCSV(text);
      if (!rows.length) throw new Error("Pr√°zdn√© CSV.");

      const headers = rows[0].map(h => normalizeKey(h));
      const idx = (name) => headers.indexOf(name);

      const iPlayer  = idx("player");
      const iRating  = idx("rating");
      const iGames   = idx("games");
      const iWin     = idx("win");
      const iLoss    = idx("loss");
      const iDraw    = idx("draw");
      const iWinrate = headers.findIndex(h => h === "winrate" || h.includes("winrate"));

      if ([iPlayer, iRating, iGames, iWin, iLoss, iDraw].some(i => i === -1) || iWinrate === -1) {
        throw new Error("Nena≈°el jsem sloupce A‚ÄìG (player,rating,games,win,loss,draw,winrate).");
      }

      const loaded = rows.slice(1)
        .map(r => ({
          player:  (r[iPlayer] ?? "").trim(),
          rating:  toNumber(r[iRating]),
          games:   toNumber(r[iGames]),
          win:     toNumber(r[iWin]),
          loss:    toNumber(r[iLoss]),
          draw:    toNumber(r[iDraw]),
          winrate: (r[iWinrate] ?? "").toString().trim()
        }))
        .filter(x => x.player.length > 0);

      loaded.sort((a, b) => (b.rating || -Infinity) - (a.rating || -Infinity));
      allRows = loaded.map((p, i) => ({ ...p, rank: i + 1 }));

      setStatus(`Naƒçteno: ${allRows.length}`);
      render(allRows);
    } catch (e) {
      setStatus("Chyba");
      showError(String(e?.message || e));
    } finally {
      refreshBtn.disabled = false;
    }
  }

  async function loadAll() {
    await Promise.all([loadStandings(), loadLastData()]);
  }

  // ---------- PLAYER DETAIL ----------
  function buildSvgLineChart(values, opts = {}) {
    const w = opts.width ?? 960;
    const h = opts.height ?? 220;
    const padX = 18, padY = 16;

    const clean = values.filter(v => Number.isFinite(v));
    if (clean.length < 2) return `<div class="muted">Graf nelze vykreslit (m√°lo dat).</div>`;

    const min = Math.min(...clean);
    const max = Math.max(...clean);
    const span = Math.max(1, max - min);

    const n = values.length;
    const x = (i) => padX + (i * (w - padX*2)) / Math.max(1, n - 1);
    const y = (v) => (h - padY) - ((v - min) * (h - padY*2)) / span;

    let points = "";
    for (let i = 0; i < values.length; i++) {
      const v = values[i];
      if (!Number.isFinite(v)) continue;
      points += `${x(i).toFixed(1)},${y(v).toFixed(1)} `;
    }

    // jednoduch√© vodorovn√© linky (3)
    const grid = [0, .5, 1].map(t => {
      const yy = padY + (1 - t) * (h - padY*2);
      return `<line x1="${padX}" y1="${yy}" x2="${w-padX}" y2="${yy}" stroke="rgba(255,255,255,.10)" />`;
    }).join("");

    return `
      <svg viewBox="0 0 ${w} ${h}" width="100%" height="220" role="img" aria-label="ELO chart">
        ${grid}
        <polyline points="${points.trim()}" fill="none" stroke="rgba(255,255,255,.85)" stroke-width="2.5" />
        <circle cx="${x(values.length-1)}" cy="${y(values[values.length-1])}" r="3.5" fill="rgba(255,215,74,.95)" />
        <text x="${padX}" y="${padY-2}" fill="rgba(255,255,255,.65)" font-size="11">min ${min}</text>
        <text x="${w-padX}" y="${padY-2}" text-anchor="end" fill="rgba(255,255,255,.65)" font-size="11">max ${max}</text>
      </svg>
    `;
  }

  function parsePlayerSheetStructure(grid) {
    // Najdeme sekce: ≈ô√°dek s n√°zvem (nap≈ô. "Grail 17.1.2026" nebo "FNM"),
    // a pod n√≠ tabulku s hlaviƒçkou obsahuj√≠c√≠ "round" a "matchid".
    const sections = [];

    const norm = (s) => normalizeKey(s).replace(/\s+/g, " ").trim();
    const isInt = (s) => /^\s*\d+\s*$/.test((s ?? "").toString());

    for (let r = 0; r < grid.length; r++) {
      const a = (grid[r][0] ?? "").toString().trim();
      if (!a) continue;

      const aN = norm(a);
      const looksLikeSection = aN.startsWith("grail") || aN === "fnm" || aN.startsWith("fnm") || aN.includes("grail");

      if (!looksLikeSection) continue;

      const sectionName = a.trim();

      // najdi hlaviƒçku tabulky pod t√≠m
      let headerRow = -1;
      for (let k = r + 1; k < Math.min(grid.length, r + 12); k++) {
        const row = grid[k].map(c => norm(c));
        if (row.includes("round") && row.includes("matchid")) {
          headerRow = k;
          break;
        }
      }
      if (headerRow === -1) continue;

      const hdr = grid[headerRow].map(c => norm(c));
      const col = (name) => hdr.indexOf(name);

      const iRound = col("round");
      const iMatch = col("matchid");
      const iOpp   = hdr.findIndex(x => x.startsWith("opponent"));
      const iRes   = col("result");
      const iDelta = hdr.findIndex(x => x.includes("(+") || x.includes("+-") || x.includes("+") || x.includes("(-)") || x === "(+)");
      const iElo   = hdr.findIndex(x => x === "elo");

      // data ≈ô√°dky: dokud prvn√≠ sloupec je ƒç√≠slo
      const rows = [];
      for (let k = headerRow + 1; k < grid.length; k++) {
        const first = (grid[k][iRound] ?? grid[k][0] ?? "").toString();
        if (!isInt(first)) break;

        rows.push({
          round: (grid[k][iRound] ?? "").toString().trim(),
          matchID: (grid[k][iMatch] ?? "").toString().trim(),
          opponent: (grid[k][iOpp] ?? "").toString().trim(),
          result: (grid[k][iRes] ?? "").toString().trim(),
          delta: (grid[k][iDelta] ?? "").toString().trim(),
          elo: toNumber(grid[k][iElo] ?? "")
        });
      }

      if (rows.length) sections.push({ name: sectionName, rows });
    }

    // slo≈æ√≠me s√©rii ELO postupnƒõ (z ≈ô√°dk≈Ø v sekc√≠ch v po≈ôad√≠, jak jsou v sheetu)
    const eloSeries = [];
    for (const s of sections) {
      for (const m of s.rows) {
        if (Number.isFinite(m.elo)) eloSeries.push(m.elo);
      }
    }

    return { sections, eloSeries };
  }

  function renderMatchesTable(section) {
    const rowsHtml = section.rows.map(m => `
      <tr>
        <td class="num">${escapeHtml(m.round)}</td>
        <td class="num">${escapeHtml(m.matchID)}</td>
        <td>${escapeHtml(m.opponent)}</td>
        <td>${escapeHtml(m.result)}</td>
        <td class="num">${escapeHtml(m.delta)}</td>
        <td class="num">${Number.isFinite(m.elo) ? m.elo.toFixed(0) : ""}</td>
      </tr>
    `).join("");

    return `
      <div class="sectionTitle">${escapeHtml(section.name)}</div>
      <div class="miniTableWrap">
        <table class="miniTable">
          <thead>
            <tr>
              <th class="num">round</th>
              <th class="num">matchID</th>
              <th>opponent (rating)</th>
              <th>result</th>
              <th class="num">(+/-)</th>
              <th class="num">Elo</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      </div>
    `;
  }

  async function loadPlayerDetail(playerObj) {
    // 1) otev≈ôi modal hned se summary (z Elo standings)
    modalName.textContent = playerObj.player;
    modalSub.textContent = "Naƒç√≠t√°m podrobnosti‚Ä¶";
    modalBody.innerHTML = buildHero(playerObj);
    openModal();

    openSheetTabBtn.onclick = () => {
      window.open(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`, "_blank", "noopener,noreferrer");
    };

    // 2) st√°hni CSV z tabu se stejn√Ωm n√°zvem
    const playerSheetUrl =
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(playerObj.player)}`;

    try {
      const u = new URL(playerSheetUrl);
      u.searchParams.set("_", Date.now().toString());

      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("HTML m√≠sto CSV");

      const grid = parseCSV(text);
      if (!grid.length) throw new Error("EMPTY");

      const { sections, eloSeries } = parsePlayerSheetStructure(grid);

      // 3) chart
      const chartEl = document.getElementById("eloChart");
      chartEl.innerHTML = buildSvgLineChart(eloSeries);

      // 4) tabulky sekc√≠
      let detailsHtml = "";
      if (sections.length) {
        detailsHtml += sections.map(renderMatchesTable).join("");
        modalSub.textContent = `Detail hr√°ƒçe ‚Ä¢ sekc√≠: ${sections.length}`;
      } else {
        modalSub.textContent = "Detail hr√°ƒçe ‚Ä¢ struktura se nepoda≈ôila rozpoznat";
        detailsHtml += `<div class="muted">Nena≈°el jsem sekce typu ‚ÄúGrail ‚Ä¶‚Äù/‚ÄúFNM‚Äù.</div>`;
      }

      modalBody.innerHTML = buildHero(playerObj) + detailsHtml;

    } catch (e) {
      // ‚úÖ TADY je oprava chov√°n√≠: modal z≈Østane a uk√°≈æe chybu
      modalSub.textContent = "Detail hr√°ƒçe";
      modalBody.innerHTML =
        buildHero(playerObj) +
        `<div class="bigError"><div class="icon">‚ùå</div> Podrobn√° data hr√°ƒçe nenalezena</div>` +
        `<div class="muted" style="margin-top:10px;">(Nenalezen list se stejn√Ωm n√°zvem jako hr√°ƒç.)</div>`;
    }
  }

  // ---------- Events ----------
  searchEl.addEventListener("input", () => render(allRows));
  refreshBtn.addEventListener("click", loadAll);

  tbody.addEventListener("click", (e) => {
    const btn = e.target.closest(".playerBtn");
    if (!btn) return;
    const playerObj = btn._playerObj;
    if (!playerObj) return;
    loadPlayerDetail(playerObj);
  });

  closeModalBtn.addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) closeModal();
  });
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modalOverlay.style.display === "block") closeModal();
  });

  // ---------- Init ----------
  loadAll();

  async function loadAll() {
    await Promise.all([loadStandings(), loadLastData()]);
  }
</script>
</body>
</html>
