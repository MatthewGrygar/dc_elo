<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ELO ≈æeb≈ô√≠ƒçek</title>

  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(900px 500px at 80% 0%, rgba(255,215,0,.08), transparent 60%),
                  #0f1115;
      color: #eef2ff;
    }

    header {
      padding: 18px 18px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(15,17,21,.6);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    header .wrap {
      max-width: 1150px;
      margin: 0 auto;
      display: flex;
      gap: 16px;
      align-items: flex-start;
      justify-content: space-between;
    }

    h1 { margin: 0 0 6px; font-size: 26px; letter-spacing: .2px; }
    .muted { opacity: .78; }
    .credit { margin-top: 6px; }

    main { max-width: 1150px; margin: 0 auto; padding: 16px; }

    .card {
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      overflow: hidden;
      background: rgba(255,255,255,.035);
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
    }

    .toolbar {
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: space-between;
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }

    .left { display:flex; gap: 12px; align-items:center; flex-wrap: wrap; }
    .right { display:flex; gap: 10px; align-items:center; }

    .badge {
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      white-space: nowrap;
    }

    input[type="search"]{
      width: min(380px, 70vw);
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: inherit;
      outline: none;
    }
    input[type="search"]:focus{
      border-color: rgba(255,255,255,.28);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }

    button{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: inherit;
      cursor: pointer;
      white-space: nowrap;
    }
    button:hover { background: rgba(255,255,255,.06); }
    button:disabled { opacity: .6; cursor: not-allowed; }

    .tableWrap { overflow:auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(15,17,21,.92);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,.12);
      font-size: 12px;
      letter-spacing: .08em;
      text-transform: uppercase;
      opacity: .85;
    }

    th, td { text-align: left; padding: 12px 12px; }
    tbody tr:nth-child(2n) { background: rgba(255,255,255,.02); }
    tbody tr:hover { background: rgba(255,255,255,.055); }

    .num { text-align: right; font-variant-numeric: tabular-nums; }
    .rank { width: 90px; font-variant-numeric: tabular-nums; }
    .playerBtn {
      border: none;
      background: none;
      color: inherit;
      cursor: pointer;
      padding: 0;
      font: inherit;
      text-decoration: underline;
      text-decoration-color: rgba(255,255,255,.25);
      text-underline-offset: 3px;
    }
    .playerBtn:hover { text-decoration-color: rgba(255,255,255,.6); }

    .r1 { color: #ffd54a; font-weight: 900; }
    .r2 { color: #d6dbe6; font-weight: 900; }
    .r3 { color: #d29a6a; font-weight: 900; }

    #error { display:none; margin-top: 12px; white-space: pre-wrap; color: #ff7a7a; }

    footer {
      padding: 12px;
      opacity: .75;
      font-size: 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }

    /* Modal */
    .modalOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(6px);
      z-index: 50;
      padding: 18px;
    }
    .modal {
      max-width: 1100px;
      margin: 0 auto;
      height: calc(100vh - 36px);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(15,17,21,.92);
      box-shadow: 0 30px 90px rgba(0,0,0,.6);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
    }
    .modalTitle{
      display:flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .modalTitle b{
      font-size: 16px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70vw;
    }
    .modalTitle span{
      font-size: 12px;
      opacity: .75;
    }

    .modalBody{
      padding: 12px;
      overflow: auto;
    }

    .playerHero{
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    .heroCard{
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 14px;
      background: rgba(255,255,255,.03);
    }
    .heroTop{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
    }
    .heroName{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
      margin: 0 0 6px;
    }
    .heroElo{
      font-size: 42px;
      font-weight: 900;
      line-height: 1;
      margin: 0;
    }
    .heroRank{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      margin-top: 10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      white-space: nowrap;
    }

    .heroMetaRow{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .statsRow{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .stat{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding: 10px 10px;
    }
    .stat b{ display:block; font-size: 12px; opacity:.75; letter-spacing:.06em; text-transform: uppercase; }
    .stat span{ display:block; margin-top: 4px; font-size: 16px; font-weight: 800; }

    .sectionTitle{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin: 18px 0 10px;
      font-size: 14px;
      letter-spacing: .06em;
      text-transform: uppercase;
      opacity: .92;
    }
    .sectionTitle .sub { font-size: 12px; opacity:.75; text-transform: none; letter-spacing: 0; }

    .miniTableWrap{ overflow:auto; border: 1px solid rgba(255,255,255,.10); border-radius: 16px; }
    .miniTable{ width:100%; border-collapse: separate; border-spacing:0; }
    .miniTable th, .miniTable td { padding: 10px 10px; border-top: 1px solid rgba(255,255,255,.08); }
    .miniTable thead th { position: sticky; top: 0; background: rgba(15,17,21,.96); border-top: none; }
    .miniTable tbody tr:nth-child(2n) { background: rgba(255,255,255,.02); }
    .miniTable .num { text-align:right; }

    .chartCard{
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 12px;
      background: rgba(255,255,255,.03);
    }

    .bigError{
      display:flex;
      align-items:center;
      gap: 12px;
      border: 1px solid rgba(255,122,122,.35);
      background: rgba(255,122,122,.08);
      color: #ffd0d0;
      border-radius: 18px;
      padding: 14px;
      margin-top: 10px;
      font-weight: 900;
    }
    .bigError .icon{ font-size: 22px; }

    @media (max-width: 860px) {
      .playerHero { grid-template-columns: 1fr; }
      .statsRow { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div>
        <h1>ELO ≈æeb≈ô√≠ƒçek</h1>
        <div class="muted">Naƒç√≠t√°no z Google Sheets (list: ‚ÄúElo standings‚Äù).</div>
        <div class="credit muted">
          Za ve≈°ker√° data dƒõkujeme <b>Ervinovi Kuƒçovi</b>, kter√Ω data souƒçasnƒõ zpravuje:
        </div>
      </div>

      <div class="badge" id="lastDataBadge">posledn√≠ data: naƒç√≠t√°m‚Ä¶</div>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="toolbar">
        <div class="left">
          <span id="status" class="badge">Naƒç√≠t√°m‚Ä¶</span>
          <input id="search" type="search" placeholder="Hledat hr√°ƒçe‚Ä¶" autocomplete="off" />
        </div>

        <div class="right">
          <button id="refresh" type="button">Znovu naƒç√≠st</button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th class="rank">Po≈ôad√≠</th>
              <th>Player</th>
              <th class="num">Rating</th>
              <th class="num">Games</th>
              <th class="num">Win</th>
              <th class="num">Loss</th>
              <th class="num">Draw</th>
              <th class="num">Winrate</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <footer>
        Tip: Klikni na jm√©no hr√°ƒçe pro detail (list se stejn√Ωm n√°zvem). Po≈ôad√≠ je ‚Äûlocknut√©‚Äú po naƒçten√≠ dat.
      </footer>
    </div>

    <div id="error"></div>
  </main>

  <!-- Modal -->
  <div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle">
          <b id="modalName">Hr√°ƒç</b>
          <span id="modalSub">Naƒç√≠t√°m‚Ä¶</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button id="openSheetTabBtn" type="button" title="Otev≈ô√≠t Google Sheet dokument">Otev≈ô√≠t Sheets</button>
          <button id="closeModalBtn" type="button">Zav≈ô√≠t</button>
        </div>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

<script>
  const SHEET_ID = "1y98bzsIRpVv0_cGNfbITapucO5A6izeEz5lTM92ZbIA";
  const ELO_SHEET_NAME = "Elo standings";
  const DATA_SHEET_NAME = "Data";

  const ELO_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(ELO_SHEET_NAME)}`;
  const DATA_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(DATA_SHEET_NAME)}`;

  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const errorEl = document.getElementById("error");
  const searchEl = document.getElementById("search");
  const refreshBtn = document.getElementById("refresh");
  const lastDataBadge = document.getElementById("lastDataBadge");

  const modalOverlay = document.getElementById("modalOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const openSheetTabBtn = document.getElementById("openSheetTabBtn");
  const modalName = document.getElementById("modalName");
  const modalSub = document.getElementById("modalSub");
  const modalBody = document.getElementById("modalBody");

  let allRows = [];

  function setStatus(text) { statusEl.textContent = text; }
  function showError(msg) { errorEl.style.display = "block"; errorEl.textContent = msg; }
  function hideError() { errorEl.style.display = "none"; errorEl.textContent = ""; }

  function escapeHtml(str) {
    return (str ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function normalizeKey(s) {
    return (s || "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu, "");
  }

  function parseCSV(csvText) {
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < csvText.length; i++) {
      const c = csvText[i];
      const next = csvText[i + 1];

      if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; }
      else if (c === '"') inQuotes = !inQuotes;
      else if (c === "," && !inQuotes) { row.push(cur); cur = ""; }
      else if ((c === "\n" || c === "\r") && !inQuotes) {
        if (c === "\r" && next === "\n") i++;
        row.push(cur); cur = "";
        if (row.some(x => x.trim() !== "")) rows.push(row);
        row = [];
      } else {
        cur += c;
      }
    }
    if (cur.length || row.length) {
      row.push(cur);
      if (row.some(x => x.trim() !== "")) rows.push(row);
    }
    return rows;
  }

  function toNumber(x) {
    if (x == null) return NaN;
    const s = x.toString().replace(/\s/g, "").replace(",", ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  async function fetchUtf8Text(url) {
    const res = await fetch(url, { cache: "no-store" });
    const buf = await res.arrayBuffer();
    const text = new TextDecoder("utf-8").decode(buf);
    return { res, text };
  }

  function rankCellHtml(rank) {
    if (rank === 1) return `<span class="r1">üëë ${rank}</span>`;
    if (rank === 2) return `<span class="r2">${rank}</span>`;
    if (rank === 3) return `<span class="r3">${rank}</span>`;
    return `${rank}`;
  }

  function openModal() {
    modalOverlay.style.display = "block";
    document.body.style.overflow = "hidden";
  }
  function closeModal() {
    modalOverlay.style.display = "none";
    document.body.style.overflow = "";
    modalBody.innerHTML = "";
  }

  function safeInt(x) { return Number.isFinite(x) ? x.toFixed(0) : ""; }

  function buildHero(playerObj, parsedMeta = null) {
    // preferuj "Current rating" z player listu, pokud existuje
    const currentFromList = parsedMeta?.currentRating;
    const elo = Number.isFinite(currentFromList) ? currentFromList.toFixed(0)
              : (Number.isFinite(playerObj.rating) ? playerObj.rating.toFixed(0) : "");

    const recordText = parsedMeta?.recordText ? `Record (W-L-D): ${parsedMeta.recordText}` : null;

    return `
      <div class="playerHero">
        <div class="heroCard">
          <div class="heroTop">
            <div style="min-width:0;">
              <div class="heroName">${escapeHtml(playerObj.player)}</div>
              <div class="muted">Po≈ôad√≠ v ≈æeb≈ô√≠ƒçku</div>
              <div class="heroRank">
                <span class="chip">${rankCellHtml(playerObj.rank)}</span>
                <span class="chip">ELO</span>
              </div>
              <div class="heroMetaRow">
                ${recordText ? `<span class="chip">${escapeHtml(recordText)}</span>` : ``}
              </div>
            </div>
            <div style="text-align:right;">
              <div class="muted">aktu√°ln√≠ rating</div>
              <div class="heroElo">${escapeHtml(elo)}</div>
            </div>
          </div>

          <div class="statsRow">
            <div class="stat"><b>games</b><span>${safeInt(playerObj.games)}</span></div>
            <div class="stat"><b>win</b><span>${safeInt(playerObj.win)}</span></div>
            <div class="stat"><b>loss</b><span>${safeInt(playerObj.loss)}</span></div>
            <div class="stat"><b>draw</b><span>${safeInt(playerObj.draw)}</span></div>
            <div class="stat"><b>winrate</b><span>${escapeHtml(playerObj.winrate || "")}</span></div>
          </div>
        </div>

        <div class="chartCard">
          <div class="muted" style="margin-bottom:8px;">V√Ωvoj ELO</div>
          <div id="eloChart" class="muted">Naƒç√≠t√°m data hr√°ƒçe‚Ä¶</div>
        </div>
      </div>
    `;
  }

  function render(rows) {
    const q = normalizeKey(searchEl.value);
    const filtered = rows.filter(r => !q || normalizeKey(r.player).includes(q));
    filtered.sort((a, b) => a.rank - b.rank);

    tbody.innerHTML = "";

    if (!filtered.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" class="muted">Nic nenalezeno.</td>`;
      tbody.appendChild(tr);
      return;
    }

    filtered.forEach((r) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="rank">${rankCellHtml(r.rank)}</td>
        <td><button class="playerBtn" type="button">${escapeHtml(r.player)}</button></td>
        <td class="num">${Number.isFinite(r.rating) ? r.rating.toFixed(0) : ""}</td>
        <td class="num">${safeInt(r.games)}</td>
        <td class="num">${safeInt(r.win)}</td>
        <td class="num">${safeInt(r.loss)}</td>
        <td class="num">${safeInt(r.draw)}</td>
        <td class="num">${escapeHtml(r.winrate || "")}</td>
      `;
      tr.querySelector(".playerBtn")._playerObj = r;
      tbody.appendChild(tr);
    });
  }

  async function loadLastData() {
    try {
      const u = new URL(DATA_CSV_URL);
      u.searchParams.set("_", Date.now().toString());

      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("HTML m√≠sto CSV");

      const rows = parseCSV(text);
      if (rows.length < 2) {
        lastDataBadge.textContent = "posledn√≠ data: (nenalezeno)";
        return;
      }

      let last = "";
      for (let i = 1; i < rows.length; i++) {
        const val = (rows[i][1] ?? "").toString().trim(); // sloupec B
        if (val) last = val;
      }
      lastDataBadge.textContent = `posledn√≠ data: ${last || "(nenalezeno)"}`;
    } catch {
      lastDataBadge.textContent = "posledn√≠ data: chyba";
    }
  }

  async function loadStandings() {
    hideError();
    setStatus("Naƒç√≠t√°m‚Ä¶");
    refreshBtn.disabled = true;

    try {
      const u = new URL(ELO_CSV_URL);
      u.searchParams.set("_", Date.now().toString());

      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("M√≠sto CSV p≈ôi≈°lo HTML.");

      const rows = parseCSV(text);
      if (!rows.length) throw new Error("Pr√°zdn√© CSV.");

      const headers = rows[0].map(h => normalizeKey(h));
      const idx = (name) => headers.indexOf(name);

      const iPlayer  = idx("player");
      const iRating  = idx("rating");
      const iGames   = idx("games");
      const iWin     = idx("win");
      const iLoss    = idx("loss");
      const iDraw    = idx("draw");
      const iWinrate = headers.findIndex(h => h === "winrate" || h.includes("winrate"));

      if ([iPlayer, iRating, iGames, iWin, iLoss, iDraw].some(i => i === -1) || iWinrate === -1) {
        throw new Error("Nena≈°el jsem sloupce A‚ÄìG (player,rating,games,win,loss,draw,winrate).");
      }

      const loaded = rows.slice(1)
        .map(r => ({
          player:  (r[iPlayer] ?? "").trim(),
          rating:  toNumber(r[iRating]),
          games:   toNumber(r[iGames]),
          win:     toNumber(r[iWin]),
          loss:    toNumber(r[iLoss]),
          draw:    toNumber(r[iDraw]),
          winrate: (r[iWinrate] ?? "").toString().trim()
        }))
        .filter(x => x.player.length > 0);

      loaded.sort((a, b) => (b.rating || -Infinity) - (a.rating || -Infinity));
      allRows = loaded.map((p, i) => ({ ...p, rank: i + 1 }));

      setStatus(`Naƒçteno: ${allRows.length}`);
      render(allRows);
    } catch (e) {
      setStatus("Chyba");
      showError(String(e?.message || e));
    } finally {
      refreshBtn.disabled = false;
    }
  }

  async function loadAll() {
    await Promise.all([loadStandings(), loadLastData()]);
  }

  // -------- Detail parsing (tailored) --------
  function buildSvgLineChart(values, opts = {}) {
    const w = opts.width ?? 960;
    const h = opts.height ?? 220;
    const padX = 18, padY = 16;

    const clean = values.filter(v => Number.isFinite(v));
    if (clean.length < 2) return `<div class="muted">Graf nelze vykreslit (m√°lo dat).</div>`;

    const min = Math.min(...clean);
    const max = Math.max(...clean);
    const span = Math.max(1, max - min);

    const n = values.length;
    const x = (i) => padX + (i * (w - padX*2)) / Math.max(1, n - 1);
    const y = (v) => (h - padY) - ((v - min) * (h - padY*2)) / span;

    let d = "";
    let started = false;
    for (let i = 0; i < values.length; i++) {
      const v = values[i];
      if (!Number.isFinite(v)) continue;
      const px = x(i), py = y(v);
      d += (started ? " L " : " M ") + px.toFixed(2) + " " + py.toFixed(2);
      started = true;
    }

    const grid = [0, .5, 1].map(t => {
      const yy = padY + (1 - t) * (h - padY*2);
      return `<line x1="${padX}" y1="${yy}" x2="${w-padX}" y2="${yy}" stroke="rgba(255,255,255,.10)" />`;
    }).join("");

    const last = clean[clean.length - 1];

    return `
      <svg viewBox="0 0 ${w} ${h}" width="100%" height="220" role="img" aria-label="ELO chart">
        ${grid}
        <path d="${d}" fill="none" stroke="rgba(255,255,255,.85)" stroke-width="2.5" />
        <text x="${padX}" y="${padY-2}" fill="rgba(255,255,255,.65)" font-size="11">min ${min}</text>
        <text x="${w-padX}" y="${padY-2}" text-anchor="end" fill="rgba(255,255,255,.65)" font-size="11">max ${max}</text>
        <text x="${w-padX}" y="${h-6}" text-anchor="end" fill="rgba(255,255,255,.70)" font-size="11">last ${last}</text>
      </svg>
    `;
  }

  function parseMetaFromGrid(grid) {
    // oƒçek√°v√°me:
    // A1: jm√©no
    // A2: "Current rating:"  B2: ƒç√≠slo
    // A3: "Record (W-L-D):"  B3: "25-7-1_"
    let currentRating = NaN;
    let recordText = "";

    for (let r = 0; r < Math.min(grid.length, 10); r++) {
      const a = (grid[r][0] ?? "").toString().trim();
      const b = (grid[r][1] ?? "").toString().trim();
      const aN = normalizeKey(a);

      if (aN.startsWith("current rating")) {
        currentRating = toNumber(b);
      }
      if (aN.startsWith("record")) {
        recordText = b.replace(/_+$/g, ""); // odstran√≠ trailing _
      }
    }

    return { currentRating, recordText };
  }

  function parseSectionsFromGrid(grid) {
    // Sekce = ≈ô√°dek kde je A: n√°zev (nap≈ô. "Grail 17.1.2026" nebo "FNM")
    // a nƒõkde na tom ≈ô√°dku je text "starting rating:" a ƒç√≠slo.
    // N√°sleduje hlaviƒçka: round matchID opponent (rating) result (+-) Elo
    // a datov√© ≈ô√°dky 1..N; po nich ≈ô√°dek TOP s meta informacemi.
    const sections = [];
    const norm = (s) => normalizeKey((s ?? "").toString()).replace(/\s+/g, " ").trim();
    const isInt = (s) => /^\s*\d+\s*$/.test((s ?? "").toString());

    const findInRow = (row, needleNorm) => row.findIndex(c => norm(c).includes(needleNorm));
    const getCell = (r, c) => (grid[r] && grid[r][c] != null) ? grid[r][c].toString().trim() : "";

    for (let r = 0; r < grid.length; r++) {
      const name = getCell(r, 0);
      if (!name) continue;

      // sekci bereme, pokud na tom ≈ô√°dku existuje "starting rating"
      const row = grid[r] || [];
      const srIdx = findInRow(row, "starting rating");
      if (srIdx === -1) continue;

      // starting rating hodnota b√Ωv√° o 1‚Äì2 sloupce vpravo
      let startingRating = NaN;
      for (let k = srIdx + 1; k < Math.min(row.length, srIdx + 4); k++) {
        const v = toNumber(row[k]);
        if (Number.isFinite(v)) { startingRating = v; break; }
      }

      // najdi hlaviƒçku tabulky
      let headerRow = -1;
      for (let k = r + 1; k < Math.min(grid.length, r + 10); k++) {
        const rowN = (grid[k] || []).map(norm);
        if (rowN.includes("round") && rowN.includes("matchid") && rowN.includes("result") && rowN.includes("elo")) {
          headerRow = k;
          break;
        }
      }
      if (headerRow === -1) continue;

      const hdrN = (grid[headerRow] || []).map(norm);
      const col = (key) => hdrN.indexOf(key);
      const iRound = col("round");
      const iMatch = col("matchid");
      const iOpp = hdrN.findIndex(x => x.startsWith("opponent"));
      const iRes = col("result");
      const iDelta = hdrN.findIndex(x => x.includes("(+-") || x === "(+-)" || x === "(+ -)" || x === "(+)" || x === "(+-)" || x.includes("(+"));
      const iElo = col("elo");

      const rows = [];
      let topRowIndex = -1;

      for (let k = headerRow + 1; k < grid.length; k++) {
        const first = getCell(k, iRound >= 0 ? iRound : 0);
        if (isInt(first)) {
          rows.push({
            round: first,
            matchID: getCell(k, iMatch),
            opponent: getCell(k, iOpp),
            result: getCell(k, iRes),
            delta: getCell(k, iDelta),
            elo: toNumber(getCell(k, iElo))
          });
          continue;
        }

        // TOP ≈ô√°dek
        const a0 = norm(getCell(k, 0));
        if (a0 === "top") {
          topRowIndex = k;
        }
        break;
      }

      let topMeta = null;
      if (topRowIndex !== -1) {
        // P≈ô√≠klad: "TOP", "", "average opponent: 1503", "record: 4-3-0", "new rating:", "1518"
        const rowTop = grid[topRowIndex] || [];
        const avIdx = findInRow(rowTop, "average opponent");
        const recIdx = findInRow(rowTop, "record:");
        const newIdx = findInRow(rowTop, "new rating");

        const parseAfterColon = (s) => {
          const m = (s ?? "").toString().split(":");
          return (m.length > 1 ? m.slice(1).join(":").trim() : (s ?? "").toString().trim());
        };

        const averageOpponent = avIdx !== -1 ? toNumber(parseAfterColon(rowTop[avIdx])) : NaN;
        const record = recIdx !== -1 ? parseAfterColon(rowTop[recIdx]).replace(/_+$/g, "") : "";
        let newRating = NaN;
        if (newIdx !== -1) {
          // nƒõkdy je "new rating:" v jedn√© bu≈àce a ƒç√≠slo v dal≈°√≠
          const maybe = toNumber(parseAfterColon(rowTop[newIdx]));
          if (Number.isFinite(maybe)) newRating = maybe;
          else {
            for (let k = newIdx + 1; k < Math.min(rowTop.length, newIdx + 4); k++) {
              const v = toNumber(rowTop[k]);
              if (Number.isFinite(v)) { newRating = v; break; }
            }
          }
        }

        topMeta = { averageOpponent, record, newRating };
      }

      if (rows.length) {
        sections.push({
          name,
          startingRating,
          rows,
          topMeta
        });
      }
    }

    // ELO series = postupnƒõ p≈ôes v≈°echny sekce a z√°pasy
    const eloSeries = [];
    for (const s of sections) {
      for (const m of s.rows) if (Number.isFinite(m.elo)) eloSeries.push(m.elo);
    }

    return { sections, eloSeries };
  }

  function renderMatchesTable(section) {
    const rowsHtml = section.rows.map(m => `
      <tr>
        <td class="num">${escapeHtml(m.round)}</td>
        <td class="num">${escapeHtml(m.matchID)}</td>
        <td>${escapeHtml(m.opponent)}</td>
        <td>${escapeHtml(m.result)}</td>
        <td class="num">${escapeHtml(m.delta)}</td>
        <td class="num">${Number.isFinite(m.elo) ? m.elo.toFixed(0) : ""}</td>
      </tr>
    `).join("");

    const top = section.topMeta;
    const topLine = top ? `
      <div class="muted" style="margin-top:8px;">
        TOP ‚Ä¢ average opponent: ${Number.isFinite(top.averageOpponent) ? top.averageOpponent.toFixed(0) : "?"}
        ‚Ä¢ record: ${escapeHtml(top.record || "?")}
        ‚Ä¢ new rating: ${Number.isFinite(top.newRating) ? top.newRating.toFixed(0) : "?"}
      </div>
    ` : ``;

    return `
      <div class="sectionTitle">
        <div>${escapeHtml(section.name)}</div>
        <div class="sub">
          starting rating: ${Number.isFinite(section.startingRating) ? section.startingRating.toFixed(0) : "?"}
        </div>
      </div>

      <div class="miniTableWrap">
        <table class="miniTable">
          <thead>
            <tr>
              <th class="num">round</th>
              <th class="num">matchID</th>
              <th>opponent (rating)</th>
              <th>result</th>
              <th class="num">(+/-)</th>
              <th class="num">Elo</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      </div>
      ${topLine}
    `;
  }

  async function loadPlayerDetail(playerObj) {
    modalName.textContent = playerObj.player;
    modalSub.textContent = "Naƒç√≠t√°m podrobnosti‚Ä¶";
    modalBody.innerHTML = buildHero(playerObj, null);
    openModal();

    openSheetTabBtn.onclick = () => {
      window.open(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`, "_blank", "noopener,noreferrer");
    };

    const playerSheetUrl =
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(playerObj.player)}`;

    try {
      const u = new URL(playerSheetUrl);
      u.searchParams.set("_", Date.now().toString());

      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("HTML m√≠sto CSV");

      const grid = parseCSV(text);
      if (!grid.length) throw new Error("EMPTY");

      const meta = parseMetaFromGrid(grid);
      const { sections, eloSeries } = parseSectionsFromGrid(grid);

      // Vykresli hero znovu s meta daty (current rating + record)
      modalBody.innerHTML = buildHero(playerObj, meta);

      // Graf
      const chartEl = document.getElementById("eloChart");
      chartEl.innerHTML = buildSvgLineChart(eloSeries);

      // Sekce
      if (!sections.length) {
        modalSub.textContent = "Detail hr√°ƒçe ‚Ä¢ sekce nenalezeny";
        modalBody.innerHTML += `<div class="muted">Nena≈°el jsem sekce (Grail/FNM). Zkontroluj strukturu listu.</div>`;
        return;
      }

      modalSub.textContent = `Detail hr√°ƒçe ‚Ä¢ sekc√≠: ${sections.length}`;
      modalBody.innerHTML += sections.map(renderMatchesTable).join("");

    } catch {
      modalSub.textContent = "Detail hr√°ƒçe";
      modalBody.innerHTML =
        buildHero(playerObj, null) +
        `<div class="bigError"><div class="icon">‚ùå</div> Podrobn√° data hr√°ƒçe nenalezena</div>` +
        `<div class="muted" style="margin-top:10px;">(Nenalezen list se stejn√Ωm n√°zvem jako hr√°ƒç.)</div>`;
    }
  }

  // ---------- Events ----------
  searchEl.addEventListener("input", () => render(allRows));
  refreshBtn.addEventListener("click", loadAll);

  tbody.addEventListener("click", (e) => {
    const btn = e.target.closest(".playerBtn");
    if (!btn) return;
    const playerObj = btn._playerObj;
    if (!playerObj) return;
    loadPlayerDetail(playerObj);
  });

  closeModalBtn.addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) closeModal(); });
  window.addEventListener("keydown", (e) => { if (e.key === "Escape" && modalOverlay.style.display === "block") closeModal(); });

  // ---------- Init ----------
  loadAll();

  async function loadAll() {
    await Promise.all([loadStandings(), loadLastData()]);
  }
</script>
</body>
</html>
