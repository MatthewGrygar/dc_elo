<!doctype html>
<html lang="cs" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ELO ≈æeb≈ô√≠ƒçek</title>

  <style>
    /* =========================
       THEME TOKENS (CSS VARS)
       ========================= */
    html[data-theme="dark"]{
      --bg0: #0f1115;
      --bg1: rgba(15,17,21,.60);
      --text: #eef2ff;
      --muted: rgba(238,242,255,.78);
      --border: rgba(255,255,255,.12);
      --border2: rgba(255,255,255,.10);
      --panel: rgba(255,255,255,.035);
      --panel2: rgba(255,255,255,.03);
      --chip: rgba(255,255,255,.06);
      --chip2: rgba(0,0,0,.18);
      --shadow: 0 18px 55px rgba(0,0,0,.35);
      --thead: rgba(15,17,21,.92);
      --hover: rgba(255,255,255,.055);
      --altrow: rgba(255,255,255,.02);
      --glow: rgba(255,255,255,.06);
      --btnPrimaryBg: rgba(255,255,255,.08);
      --btnPrimaryBd: rgba(255,255,255,.22);

      --winBg: rgba(60, 220, 120, .10);
      --winBd: rgba(60, 220, 120, .22);
      --lossBg: rgba(255, 90, 90, .10);
      --lossBd: rgba(255, 90, 90, .22);
      --drawBg: rgba(255, 170, 60, .10);
      --drawBd: rgba(255, 170, 60, .22);
    }

    html[data-theme="light"]{
      /* b√©≈æovƒõ mramorov√© pozad√≠ */
      --bg0: #f3efe6;
      --bg1: rgba(243,239,230,.70);
      --text: #151515;
      --muted: rgba(21,21,21,.70);
      --border: rgba(0,0,0,.10);
      --border2: rgba(0,0,0,.08);
      --panel: rgba(255,255,255,.70);
      --panel2: rgba(255,255,255,.55);
      --chip: rgba(255,255,255,.70);
      --chip2: rgba(255,255,255,.72);
      --shadow: 0 18px 50px rgba(0,0,0,.12);
      --thead: rgba(255,255,255,.92);
      --hover: rgba(0,0,0,.035);
      --altrow: rgba(0,0,0,.018);
      --glow: rgba(0,0,0,.05);
      --btnPrimaryBg: rgba(255,255,255,.75);
      --btnPrimaryBd: rgba(0,0,0,.14);

      --winBg: rgba(60, 220, 120, .14);
      --winBd: rgba(20, 150, 70, .22);
      --lossBg: rgba(255, 90, 90, .14);
      --lossBd: rgba(190, 40, 40, .22);
      --drawBg: rgba(255, 170, 60, .16);
      --drawBd: rgba(180, 110, 20, .22);
    }

    :root { color-scheme: light dark; }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:0;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(255,215,0,.08), transparent 60%),
        radial-gradient(900px 500px at 20% 80%, rgba(80,120,255,.06), transparent 60%),
        var(--bg0);
    }

    html[data-theme="light"] body{
      background:
        radial-gradient(900px 420px at 10% 0%, rgba(255,255,255,.80), transparent 55%),
        radial-gradient(800px 380px at 90% 10%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(900px 500px at 25% 95%, rgba(210,190,160,.35), transparent 60%),
        linear-gradient(120deg, rgba(230,220,205,.55), transparent 45%),
        linear-gradient(25deg, rgba(255,255,255,.65), transparent 55%),
        var(--bg0);
    }

    header{
      padding:18px 18px 14px;
      border-bottom:1px solid var(--border2);
      background: var(--bg1);
      backdrop-filter: blur(10px);
      position: sticky;
      top:0;
      z-index:5;
    }
    header .wrap{
      max-width:1150px;
      margin:0 auto;
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
    }

    h1{ margin:0 0 6px; font-size:26px; letter-spacing:.2px; }
    .muted{ opacity:1; color: var(--muted); }
    .credit{ margin-top:6px; }

    .container{
      max-width:1150px;
      margin:0 auto;
      padding: 0 16px;
    }

    main{ max-width:1150px; margin:0 auto; padding:16px; }

    .card{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:20px;
      overflow:hidden;
      background: var(--panel);
      box-shadow: var(--shadow);
    }

    .toolbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:12px;
      border-bottom:1px solid var(--border2);
      background: var(--panel2);
    }
    .left{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .right{ display:flex; gap:10px; align-items:center; }

    .badge{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--chip);
      white-space:nowrap;
    }

    input[type="search"]{
      width:min(380px, 70vw);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: var(--chip2);
      color:inherit;
      outline:none;
    }
    input[type="search"]:focus{
      border-color: rgba(120,120,120,.35);
      box-shadow:0 0 0 4px var(--glow);
    }

    button{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: var(--chip2);
      color:inherit;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover{ filter: brightness(1.06); }

    .btnPrimary{
      border-color: var(--btnPrimaryBd);
      background: var(--btnPrimaryBg);
      font-weight: 900;
      letter-spacing: .04em;
      text-transform: uppercase;
      padding: 10px 14px;
    }

    /* Header left: BIG logo (no panel) + texts */
    .headerLeft{
      display:flex;
      gap:16px;
      align-items:flex-start;
    }
    .logo{
      width:118px;
      height:118px;
      flex: 0 0 118px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      margin-top:-4px;
    }
    .logo img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.22));
    }

    /* Header right group (badge + request + theme) */
    .headerRight{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-end;
    }
    .headerRightTop{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .themeRow{
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:flex-end;
      width:100%;
    }
    .themeToggle{
      padding:7px 10px;
      border-radius:999px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      background: var(--chip);
      cursor:pointer;
      user-select:none;
    }
    .themeToggle .dot{
      width:8px; height:8px; border-radius:50%;
      background: rgba(120,120,120,.6);
      display:inline-block;
    }
    .themeHint{ font-size:12px; color: var(--muted); }

    /* Info panel */
    .infoBar{
      margin:12px 0 12px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:16px;
      background: var(--panel2);
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    .infoItem{
      border:1px solid var(--border2);
      border-radius:14px;
      padding:10px 10px;
      background: rgba(0,0,0,.06);
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    html[data-theme="light"] .infoItem{ background: rgba(255,255,255,.50); }

    .infoItem b{
      font-size:11px;
      letter-spacing:.08em;
      text-transform: uppercase;
      opacity:.85;
      white-space:nowrap;
    }
    .infoItem span{
      font-variant-numeric: tabular-nums;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      text-align:right;
      min-width: 0;
    }

    .tableWrap{ overflow:auto; }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background: var(--thead);
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--border2);
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.85;
    }
    th, td{ text-align:left; padding:12px 12px; }
    tbody tr:nth-child(2n){ background: var(--altrow); }
    tbody tr:hover{ background: var(--hover); }
    .num{ text-align:right; font-variant-numeric: tabular-nums; }
    .rank{ width:90px; font-variant-numeric: tabular-nums; }

    .playerBtn{
      border:none;
      background:none;
      color:inherit;
      cursor:pointer;
      padding:0;
      font:inherit;
      text-decoration: underline;
      text-decoration-color: rgba(120,120,120,.35);
      text-underline-offset:3px;
    }

    .r1{ color:#ffd54a; font-weight:900; }
    .r2{ color:#b6bcc8; font-weight:900; }
    html[data-theme="light"] .r2{ color:#6b6f77; }
    .r3{ color:#d29a6a; font-weight:900; }

    #error{ display:none; margin-top:12px; white-space:pre-wrap; color:#ff4d4d; }

    footer{
      padding:12px;
      opacity:.75;
      font-size:12px;
      border-top:1px solid var(--border2);
      background: var(--panel2);
      color: var(--muted);
    }

    /* Modal */
    .modalOverlay{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(6px);
      z-index:50;
      padding:18px;
    }
    .modal{
      max-width:1100px;
      margin:0 auto;
      height: calc(100vh - 36px);
      border-radius:20px;
      border:1px solid var(--border);
      background: var(--thead);
      box-shadow:0 30px 90px rgba(0,0,0,.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      color: var(--text);
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border-bottom:1px solid var(--border2);
      background: var(--panel2);
    }
    .modalTitle{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .modalTitle b{
      font-size:16px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 70vw;
    }
    .modalTitle span{ font-size:12px; color: var(--muted); }
    .modalBody{ padding:12px; overflow:auto; }

    /* HERO 2 columns */
    .heroGrid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:12px;
      margin-bottom:14px;
      align-items: stretch;
    }
    .box{
      border:1px solid var(--border);
      border-radius:18px;
      background: var(--panel);
      overflow:hidden;
    }
    .boxPad{ padding:14px; }

    .heroName{ font-size:22px; font-weight:900; margin:0 0 6px; }
    .rankLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .rankLine .muted{ color: var(--muted); }
    .rankPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      background: var(--chip);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      white-space:nowrap;
    }

    .heroEloLabel{ color: var(--muted); font-size:12px; }
    .heroElo{ font-size:44px; font-weight:900; line-height:1; margin:6px 0 0; }

    .statsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      margin-top:12px;
    }
    .statsGridRow2{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:8px;
      margin-top:8px;
    }
    .stat{
      border:1px solid var(--border2);
      border-radius:14px;
      padding:10px;
      background: var(--panel2);
    }
    .stat b{ display:block; font-size:12px; color: var(--muted); letter-spacing:.06em; text-transform:uppercase; }
    .stat span{ display:block; margin-top:4px; font-size:16px; font-weight:900; }

    .statWin{ background: var(--winBg); border-color: var(--winBd); }
    .statLoss{ background: var(--lossBg); border-color: var(--lossBd); }
    .statDraw{ background: var(--drawBg); border-color: var(--drawBd); }

    .chartHead{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin-bottom:8px;
    }
    .chartHead b{ font-size:13px; letter-spacing:.08em; text-transform:uppercase; opacity:.9; }
    .chartHead span{ font-size:12px; color: var(--muted); }
    #eloChart{ min-height: 220px; color: var(--muted); }

    .bigError{
      display:flex;
      align-items:center;
      gap:12px;
      border:1px solid rgba(255,122,122,.35);
      background: rgba(255,122,122,.12);
      color:#7a1f1f;
      border-radius:18px;
      padding:14px;
      margin-top:10px;
      font-weight:900;
    }
    html[data-theme="dark"] .bigError{ color:#ffd0d0; }
    .bigError .icon{ font-size:22px; }

    .sectionTitle{
      margin: 18px 0 10px;
      font-size: 13px;
      letter-spacing: .08em;
      text-transform: uppercase;
      opacity: .9;
    }

    .tbl{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--border2);
      border-radius:16px;
      background: var(--panel2);
    }
    .tbl th, .tbl td{
      padding:10px 10px;
      border-bottom:1px solid var(--border2);
      font-size:13px;
      vertical-align:top;
    }
    .tbl thead th{
      background: var(--thead);
      position: sticky;
      top:0;
      z-index:1;
      text-transform: uppercase;
      letter-spacing:.08em;
      font-size:11px;
      opacity:.85;
    }
    .tbl tr:last-child td{ border-bottom:none; }
    .tbl td.num{ text-align:right; font-variant-numeric: tabular-nums; }

    /* =========================
       MOBILE IMPROVEMENTS
       ========================= */
    @media (max-width: 560px){
      header{ padding:14px 14px 12px; }
      header .wrap{ flex-direction: column; gap:12px; }

      .logo{
        width:84px;
        height:84px;
        flex-basis:84px;
        margin-top:0;
      }

      h1{
        font-size:20px;
        margin-bottom:4px;
      }
      .muted{
        font-size:13px;
        line-height:1.25;
      }
      .credit{ margin-top:4px; }

      .headerLeft{ gap:12px; align-items:flex-start; }
      .headerRight{ align-items:flex-start; }
      .headerRightTop{ justify-content:flex-start; width:100%; }
      .themeRow{ justify-content:flex-start; }

      /* ‚úÖ info panel pod sebe */
      .infoBar{
        grid-template-columns: 1fr;  /* m√≠sto 2 sloupc≈Ø -> 1 sloupec */
        gap:8px;
        padding:10px;
      }
      .infoItem{
        padding:12px 12px;
        min-height:54px;
      }
      .infoItem b{ font-size:10px; }
      .infoItem span{
        font-size:15px;
        white-space:nowrap;
      }

      /* Toolbar stack */
      .toolbar{
        flex-direction: column;
        align-items: stretch;
        gap:10px;
      }
      .left{ width:100%; }
      input[type="search"]{ width:100%; }
      .right{ width:100%; justify-content:flex-end; }

      /* ‚úÖ Table on mobile: NO horizontal scroll, show only Player + Rating */
      .tableWrap{
        overflow-x:hidden; /* ≈æ√°dn√Ω scroll doprava */
      }
      table{
        table-layout: fixed;
      }
      th, td{
        padding:10px 10px;
      }
      .rank{ width:0; }
      .colRank, .colGames, .colWin, .colLoss, .colDraw, .colWinrate{
        display:none !important;
      }
      .playerCol{
        width: 70%;
      }
      .ratingCol{
        width: 30%;
      }

      /* Modal hero stack */
      .heroGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="headerLeft">
      <div class="logo">
        <img src="logo.png" alt="Logo" onerror="this.onerror=null;this.src='logo.jpg';" />
      </div>
      <div>
        <h1>ELO ≈æeb≈ô√≠ƒçek</h1>
        <div class="muted">Naƒç√≠t√°no z Google Sheets (list: ‚ÄúElo standings‚Äù).</div>
        <div class="credit muted">
          Za ve≈°ker√° data dƒõkujeme <b>Ervinovi Kuƒçovi</b>, kter√Ω data souƒçasnƒõ zpravuje:
        </div>
      </div>
    </div>

    <div class="headerRight">
      <div class="headerRightTop">
        <div class="badge" id="lastDataBadge">naƒçteno: naƒç√≠t√°m‚Ä¶</div>
        <button class="btnPrimary" id="requestUploadBtn" type="button">ZA≈Ω√ÅDAT O NAHR√ÅN√ç DAT</button>
      </div>

      <div class="themeRow">
        <div class="themeToggle" id="themeToggle" title="P≈ôepnout re≈æim">
          <span id="themeIcon">üåô</span>
          <span class="dot"></span>
          <span id="themeLabel">Tmav√Ω</span>
        </div>
        <div class="themeHint">re≈æim</div>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <div class="infoBar" id="infoBar" aria-label="Souhrn">
    <div class="infoItem"><b>pr≈Ømƒõrn√© ELO</b><span id="avgElo">‚Äî</span></div>
    <div class="infoItem"><b>pr≈Ømƒõrn√Ω winrate</b><span id="avgWinrate">‚Äî</span></div>
    <div class="infoItem"><b>celkov√Ω poƒçet her</b><span id="totalGames">‚Äî</span></div>
    <div class="infoItem"><b>posledn√≠ turnaj</b><span id="lastTournament">‚Äî</span></div>
  </div>
</div>

<main>
  <div class="card">
    <div class="toolbar">
      <div class="left">
        <span id="status" class="badge">Naƒç√≠t√°m‚Ä¶</span>
        <input id="search" type="search" placeholder="Hledat hr√°ƒçe‚Ä¶" autocomplete="off" />
      </div>
      <div class="right">
        <button id="refresh" type="button">Znovu naƒç√≠st</button>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
        <tr>
          <th class="rank colRank">Po≈ôad√≠</th>
          <th class="playerCol">Player</th>
          <th class="num ratingCol">Rating</th>
          <th class="num colGames">Games</th>
          <th class="num colWin">Win</th>
          <th class="num colLoss">Loss</th>
          <th class="num colDraw">Draw</th>
          <th class="num colWinrate">Winrate</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <footer>Tip: Klikni na jm√©no hr√°ƒçe pro detail. Na mobilu se zobrazuje jen Player + Rating (bez scrollu doprava).</footer>
  </div>

  <div id="error"></div>
</main>

<!-- Modal -->
<div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHeader">
      <div class="modalTitle">
        <b id="modalName">Hr√°ƒç</b>
        <span id="modalSub">Naƒç√≠t√°m‚Ä¶</span>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="openSheetTabBtn" type="button">Otev≈ô√≠t Sheets</button>
        <button id="closeModalBtn" type="button">Zav≈ô√≠t</button>
      </div>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
  /* =========================
     THEME TOGGLE
     ========================= */
  const htmlEl = document.documentElement;
  const themeToggle = document.getElementById("themeToggle");
  const themeIcon = document.getElementById("themeIcon");
  const themeLabel = document.getElementById("themeLabel");

  function applyTheme(theme){
    htmlEl.setAttribute("data-theme", theme);
    const isLight = theme === "light";
    themeIcon.textContent = isLight ? "‚òÄÔ∏è" : "üåô";
    themeLabel.textContent = isLight ? "Svƒõtl√Ω" : "Tmav√Ω";
  }

  function initTheme(){
    const saved = localStorage.getItem("theme");
    if (saved === "light" || saved === "dark"){
      applyTheme(saved);
      return;
    }
    const prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
    applyTheme(prefersLight ? "light" : "dark");
  }

  themeToggle.addEventListener("click", () => {
    const cur = htmlEl.getAttribute("data-theme") || "dark";
    const next = cur === "dark" ? "light" : "dark";
    applyTheme(next);
    localStorage.setItem("theme", next);
  });

  initTheme();

  /* =========================
     SHEETS + APP
     ========================= */
  const SHEET_ID = "1y98bzsIRpVv0_cGNfbITapucO5A6izeEz5lTM92ZbIA";
  const ELO_SHEET_NAME = "Elo standings";
  const DATA_SHEET_NAME = "Data";
  const PLAYER_CARDS_SHEET_NAME = "Player cards (SCV)";

  const ELO_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(ELO_SHEET_NAME)}`;
  const DATA_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(DATA_SHEET_NAME)}`;
  const PLAYER_CARDS_CSV_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(PLAYER_CARDS_SHEET_NAME)}`;

  const statusEl = document.getElementById("status");
  const tbody = document.getElementById("tbody");
  const errorEl = document.getElementById("error");
  const searchEl = document.getElementById("search");
  const refreshBtn = document.getElementById("refresh");
  const lastDataBadge = document.getElementById("lastDataBadge");

  const avgEloEl = document.getElementById("avgElo");
  const avgWinrateEl = document.getElementById("avgWinrate");
  const totalGamesEl = document.getElementById("totalGames");
  const lastTournamentEl = document.getElementById("lastTournament");
  const requestUploadBtn = document.getElementById("requestUploadBtn");

  const modalOverlay = document.getElementById("modalOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const openSheetTabBtn = document.getElementById("openSheetTabBtn");
  const modalName = document.getElementById("modalName");
  const modalSub = document.getElementById("modalSub");
  const modalBody = document.getElementById("modalBody");

  let allRows = [];
  let lastTournamentText = "";
  let playerCardsCache = null; // cache parsed Player cards

  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function normalizeKey(s){
    return (s || "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu,"");
  }
  function setStatus(text){ statusEl.textContent = text; }
  function showError(msg){ errorEl.style.display="block"; errorEl.textContent = msg; }
  function hideError(){ errorEl.style.display="none"; errorEl.textContent=""; }
  function toNumber(x){
    if (x == null) return NaN;
    const s = x.toString().replace(/\s/g,"").replace(",",".");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }
  function safeInt(x){ return Number.isFinite(x) ? x.toFixed(0) : ""; }

  function formatNow(){
    return new Intl.DateTimeFormat("cs-CZ", {
      year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit"
    }).format(new Date());
  }

  async function fetchUtf8Text(url){
    const res = await fetch(url, { cache: "no-store" });
    const buf = await res.arrayBuffer();
    const text = new TextDecoder("utf-8").decode(buf);
    return { res, text };
  }

  function parseCSV(csvText){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i=0;i<csvText.length;i++){
      const c = csvText[i];
      const next = csvText[i+1];
      if (c === '"' && inQuotes && next === '"'){ cur += '"'; i++; }
      else if (c === '"'){ inQuotes = !inQuotes; }
      else if (c === "," && !inQuotes){ row.push(cur); cur=""; }
      else if ((c === "\n" || c === "\r") && !inQuotes){
        if (c === "\r" && next === "\n") i++;
        row.push(cur); cur="";
        if (row.some(x => x.trim() !== "")) rows.push(row);
        row = [];
      } else cur += c;
    }
    if (cur.length || row.length){
      row.push(cur);
      if (row.some(x => x.trim() !== "")) rows.push(row);
    }
    return rows;
  }

  function rankCellHtml(rank){
    if (rank === 1) return `<span class="r1">üëë ${rank}</span>`;
    if (rank === 2) return `<span class="r2">${rank}</span>`;
    if (rank === 3) return `<span class="r3">${rank}</span>`;
    return `${rank}`;
  }

  function openModal(){
    modalOverlay.style.display="block";
    document.body.style.overflow="hidden";
  }
  function closeModal(){
    modalOverlay.style.display="none";
    document.body.style.overflow="";
    modalBody.innerHTML="";
  }

  function parseWinrateToNumber(winrateText){
    if (!winrateText) return NaN;
    const s = winrateText.toString().trim();
    if (!s) return NaN;
    if (s.includes("%")) return toNumber(s.replace("%",""));
    const n = toNumber(s);
    if (!Number.isFinite(n)) return NaN;
    if (n > 0 && n <= 1) return n * 100;
    return n;
  }

  // MEDI√ÅN ELO + total games / 2
  function updateInfoBar(){
    const ratings = allRows.map(r => r.rating).filter(Number.isFinite).sort((a,b)=>a-b);
    const gamesArr = allRows.map(r => r.games).filter(Number.isFinite);
    const winrates = allRows.map(r => parseWinrateToNumber(r.winrate)).filter(Number.isFinite);

    let medianElo = NaN;
    if (ratings.length){
      const mid = Math.floor(ratings.length / 2);
      medianElo = (ratings.length % 2 === 1)
        ? ratings[mid]
        : (ratings[mid - 1] + ratings[mid]) / 2;
    }

    const totalGamesRaw = gamesArr.length ? gamesArr.reduce((a,b)=>a+b,0) : NaN;
    const totalGames = Number.isFinite(totalGamesRaw) ? (totalGamesRaw / 2) : NaN;

    const avgWinrate = winrates.length ? (winrates.reduce((a,b)=>a+b,0) / winrates.length) : NaN;

    avgEloEl.textContent = Number.isFinite(medianElo) ? medianElo.toFixed(0) : "‚Äî";
    totalGamesEl.textContent = Number.isFinite(totalGames) ? totalGames.toFixed(0) : "‚Äî";
    avgWinrateEl.textContent = Number.isFinite(avgWinrate) ? `${avgWinrate.toFixed(0)}%` : "‚Äî";
    lastTournamentEl.textContent = lastTournamentText || "‚Äî";
  }

  async function loadLastData(){
    const ts = formatNow();
    lastDataBadge.textContent = `naƒçteno: ${ts}`;

    try{
      const u = new URL(DATA_CSV_URL);
      u.searchParams.set("_", Date.now().toString());
      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("HTML m√≠sto CSV");

      const rows = parseCSV(text);
      let last = "";
      for (let i=1;i<rows.length;i++){
        const v = (rows[i][1] ?? "").toString().trim(); // col B
        if (v) last = v;
      }
      lastTournamentText = last || "";
      updateInfoBar();
    } catch {
      lastTournamentText = "";
      updateInfoBar();
    }
  }

  function renderStandings(rows){
    const q = normalizeKey(searchEl.value);
    const filtered = rows.filter(r => !q || normalizeKey(r.player).includes(q));
    filtered.sort((a,b) => a.rank - b.rank);

    tbody.innerHTML = "";
    if (!filtered.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" class="muted">Nic nenalezeno.</td>`;
      tbody.appendChild(tr);
      return;
    }

    for (const r of filtered){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="rank colRank">${rankCellHtml(r.rank)}</td>
        <td class="playerCol"><button class="playerBtn" type="button">${escapeHtml(r.player)}</button></td>
        <td class="num ratingCol">${Number.isFinite(r.rating) ? r.rating.toFixed(0) : ""}</td>
        <td class="num colGames">${safeInt(r.games)}</td>
        <td class="num colWin">${safeInt(r.win)}</td>
        <td class="num colLoss">${safeInt(r.loss)}</td>
        <td class="num colDraw">${safeInt(r.draw)}</td>
        <td class="num colWinrate">${escapeHtml(r.winrate || "")}</td>
      `;
      tr.querySelector(".playerBtn")._playerObj = r;
      tbody.appendChild(tr);
    }
  }

  async function loadStandings(){
    hideError();
    setStatus("Naƒç√≠t√°m‚Ä¶");
    refreshBtn.disabled = true;

    try{
      const u = new URL(ELO_CSV_URL);
      u.searchParams.set("_", Date.now().toString());
      const { res, text } = await fetchUtf8Text(u.toString());
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      if (text.trim().startsWith("<")) throw new Error("M√≠sto CSV p≈ôi≈°lo HTML.");

      const rows = parseCSV(text);
      if (!rows.length) throw new Error("Pr√°zdn√© CSV.");

      const headers = rows[0].map(h => normalizeKey(h));
      const idx = (name) => headers.indexOf(name);

      const iPlayer  = idx("player");
      const iRating  = idx("rating");
      const iGames   = idx("games");
      const iWin     = idx("win");
      const iLoss    = idx("loss");
      const iDraw    = idx("draw");
      const iWinrate = headers.findIndex(h => h === "winrate" || h.includes("winrate"));

      if ([iPlayer,iRating,iGames,iWin,iLoss,iDraw].some(i => i === -1) || iWinrate === -1){
        throw new Error(`Nena≈°el jsem sloupce player,rating,games,win,loss,draw,winrate. Hlaviƒçky: ${headers.join(", ")}`);
      }

      const loaded = rows.slice(1).map(r => ({
        player: (r[iPlayer] ?? "").trim(),
        rating: toNumber(r[iRating]),
        games:  toNumber(r[iGames]),
        win:    toNumber(r[iWin]),
        loss:   toNumber(r[iLoss]),
        draw:   toNumber(r[iDraw]),
        winrate:(r[iWinrate] ?? "").toString().trim()
      })).filter(x => x.player.length > 0);

      loaded.sort((a,b) => (b.rating || -Infinity) - (a.rating || -Infinity));
      allRows = loaded.map((p,i) => ({ ...p, rank: i + 1 }));

      setStatus(`Naƒçteno: ${allRows.length}`);
      renderStandings(allRows);
      updateInfoBar();
    } catch(e){
      setStatus("Chyba");
      showError(String(e?.message || e));
    } finally {
      refreshBtn.disabled = false;
    }
  }

  async function loadAll(){
    await Promise.all([loadStandings(), loadLastData()]);
    // invalidate cache so "Player cards" refresh works after reload
    playerCardsCache = null;
  }

  /* =========================
     PLAYER CARDS (SCV) loader
     ========================= */
  async function loadPlayerCardsCSV(){
    if (playerCardsCache) return playerCardsCache;

    const u = new URL(PLAYER_CARDS_CSV_URL);
    u.searchParams.set("_", Date.now().toString());
    const { res, text } = await fetchUtf8Text(u.toString());
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    if (text.trim().startsWith("<")) throw new Error("HTML m√≠sto CSV");

    const rows = parseCSV(text);
    if (rows.length < 2) throw new Error("Player cards (SCV): pr√°zdn√© CSV");

    // Expect header row in row[0]
    const header = rows[0].map(h => normalizeKey(h));
    const col = (name) => header.indexOf(normalizeKey(name));

    // columns by letter (fallback to fixed positions):
    // A Player, B Match ID, C tournament, D tournament_detail, E date, F Opponent (rating), G result, H (+-), I elo
    const iPlayer = col("player") !== -1 ? col("player") : 0;
    const iMatch  = header.findIndex(h => h === "match id" || h === "matchid") !== -1 ? header.findIndex(h => h === "match id" || h === "matchid") : 1;
    const iTour   = col("tournament") !== -1 ? col("tournament") : 2;
    const iTourDet= col("tournament_detail") !== -1 ? col("tournament_detail") : 3;
    const iDate   = col("date") !== -1 ? col("date") : 4;
    const iOpp    = header.findIndex(h => h.includes("opponent")) !== -1 ? header.findIndex(h => h.includes("opponent")) : 5;
    const iRes    = col("result") !== -1 ? col("result") : 6;
    const iDelta  = header.findIndex(h => h.includes("(+-)") || h.includes("+") || h.includes("+-")) !== -1 ? header.findIndex(h => h.includes("(+-)") || h.includes("+") || h.includes("+-")) : 7;
    const iElo    = col("elo") !== -1 ? col("elo") : 8;

    const items = rows.slice(1).map(r => ({
      player: (r[iPlayer] ?? "").toString().trim(),
      matchId: toNumber((r[iMatch] ?? "").toString().trim()),
      tournament: (r[iTour] ?? "").toString().trim(),
      tournamentDetail: (r[iTourDet] ?? "").toString().trim(),
      date: (r[iDate] ?? "").toString().trim(),
      opponent: (r[iOpp] ?? "").toString().trim(),
      result: (r[iRes] ?? "").toString().trim(),
      delta: (r[iDelta] ?? "").toString().trim(),
      elo: toNumber((r[iElo] ?? "").toString().trim())
    })).filter(x => x.player);

    playerCardsCache = items;
    return items;
  }

  /* =========================
     CHART (x = matchId, y = elo)
     ========================= */
  function buildSvgLineChartXY(points){
    const clean = points.filter(p => Number.isFinite(p.x) && Number.isFinite(p.y));
    if (clean.length < 2){
      return `<div class="muted">Graf nelze vykreslit (m√°lo dat).</div>`;
    }

    const w = 960, h = 220, padX = 24, padY = 18;
    const minX = Math.min(...clean.map(p => p.x));
    const maxX = Math.max(...clean.map(p => p.x));
    const minY = Math.min(...clean.map(p => p.y));
    const maxY = Math.max(...clean.map(p => p.y));

    const spanX = Math.max(1, maxX - minX);
    const spanY = Math.max(1, maxY - minY);

    const x = (v) => padX + ((v - minX) * (w - padX*2)) / spanX;
    const y = (v) => (h - padY) - ((v - minY) * (h - padY*2)) / spanY;

    let d = "";
    for (let i=0;i<clean.length;i++){
      const p = clean[i];
      d += (i===0 ? " M " : " L ") + x(p.x).toFixed(2) + " " + y(p.y).toFixed(2);
    }

    const grid = [0, .5, 1].map(t => {
      const yy = padY + (1 - t) * (h - padY*2);
      return `<line x1="${padX}" y1="${yy}" x2="${w-padX}" y2="${yy}" stroke="rgba(120,120,120,.18)" />`;
    }).join("");

    // axis labels (small)
    const labelColor = "rgba(120,120,120,.75)";
    return `
      <svg viewBox="0 0 ${w} ${h}" width="100%" height="220" role="img" aria-label="ELO chart">
        ${grid}
        <path d="${d}" fill="none" stroke="rgba(120,120,120,.92)" stroke-width="2.5" />
        <text x="${padX}" y="${padY-4}" fill="${labelColor}" font-size="11">ELO ${Math.round(minY)}‚Äì${Math.round(maxY)}</text>
        <text x="${padX}" y="${h-6}" fill="${labelColor}" font-size="11">Match ID ${Math.round(minX)}‚Äì${Math.round(maxX)}</text>
        <circle cx="${x(clean[clean.length-1].x)}" cy="${y(clean[clean.length-1].y)}" r="3.5" fill="rgba(120,120,120,.95)" />
      </svg>
    `;
  }

  function buildHero2col(playerObj){
    const eloText = Number.isFinite(playerObj.rating) ? playerObj.rating.toFixed(0) : "";
    const rankRight = `<span class="rankPill">${rankCellHtml(playerObj.rank)}</span>`;

    return `
      <div class="heroGrid">
        <div class="box boxPad">
          <div class="heroName">${escapeHtml(playerObj.player)}</div>

          <div class="rankLine">
            <div class="muted">Po≈ôad√≠ v ≈æeb≈ô√≠ƒçku</div>
            ${rankRight}
          </div>

          <div style="margin-top:10px;">
            <div class="heroEloLabel">aktu√°ln√≠ rating</div>
            <div class="heroElo">${escapeHtml(eloText)}</div>
          </div>

          <div class="statsGrid">
            <div class="stat"><b>games</b><span>${safeInt(playerObj.games)}</span></div>
            <div class="stat"><b>winrate</b><span>${escapeHtml(playerObj.winrate || "")}</span></div>
          </div>

          <div class="statsGridRow2">
            <div class="stat statWin"><b>win</b><span>${safeInt(playerObj.win)}</span></div>
            <div class="stat statLoss"><b>loss</b><span>${safeInt(playerObj.loss)}</span></div>
            <div class="stat statDraw"><b>draw</b><span>${safeInt(playerObj.draw)}</span></div>
          </div>
        </div>

        <div class="box boxPad">
          <div class="chartHead">
            <b>V√Ωvoj ELO</b>
            <span id="chartMeta" class="muted">Naƒç√≠t√°m data hr√°ƒçe‚Ä¶</span>
          </div>
          <div id="eloChart" class="muted">Naƒç√≠t√°m data hr√°ƒçe‚Ä¶</div>
        </div>
      </div>
    `;
  }

  function buildTournamentTable(rows){
    const head = `
      <thead>
        <tr>
          <th class="num">Match ID</th>
          <th>Turnaj detail</th>
          <th>Datum</th>
          <th>Opponent (rating)</th>
          <th>Result</th>
          <th class="num">(+/-)</th>
          <th class="num">ELO</th>
        </tr>
      </thead>
    `;

    const body = rows.map(r => `
      <tr>
        <td class="num">${Number.isFinite(r.matchId) ? r.matchId.toFixed(0) : ""}</td>
        <td>${escapeHtml(r.tournamentDetail || "")}</td>
        <td>${escapeHtml(r.date || "")}</td>
        <td>${escapeHtml(r.opponent || "")}</td>
        <td>${escapeHtml(r.result || "")}</td>
        <td class="num">${escapeHtml(r.delta || "")}</td>
        <td class="num">${Number.isFinite(r.elo) ? r.elo.toFixed(0) : ""}</td>
      </tr>
    `).join("");

    return `<table class="tbl">${head}<tbody>${body}</tbody></table>`;
  }

  async function loadPlayerDetail(playerObj){
    modalName.textContent = playerObj.player;
    modalSub.textContent = "Naƒç√≠t√°m detail‚Ä¶";
    modalBody.innerHTML = buildHero2col(playerObj);
    openModal();

    openSheetTabBtn.onclick = () => {
      window.open(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`, "_blank", "noopener,noreferrer");
    };

    try{
      const allCards = await loadPlayerCardsCSV();
      const wantedName = playerObj.player.trim();

      const cards = allCards.filter(r => r.player === wantedName);

      if (!cards.length){
        modalSub.textContent = "Detail hr√°ƒçe";
        modalBody.innerHTML = buildHero2col(playerObj) +
          `<div class="bigError"><div class="icon">‚ùå</div> Podrobn√° data hr√°ƒçe nenalezena</div>`;
        return;
      }

      // sort by Match ID for chart
      const sortedForChart = [...cards].filter(r => Number.isFinite(r.matchId) && Number.isFinite(r.elo))
        .sort((a,b) => a.matchId - b.matchId);

      const points = sortedForChart.map(r => ({ x: r.matchId, y: r.elo }));
      const chartEl = document.getElementById("eloChart");
      const chartMeta = document.getElementById("chartMeta");

      chartEl.innerHTML = buildSvgLineChartXY(points);
      if (sortedForChart.length){
        const last = sortedForChart[sortedForChart.length-1];
        chartMeta.textContent = `z√°pas≈Ø: ${sortedForChart.length} ‚Ä¢ posledn√≠ Match ID: ${last.matchId.toFixed(0)} ‚Ä¢ posledn√≠ ELO: ${last.elo.toFixed(0)}`;
      } else {
        chartMeta.textContent = `Nelze vykreslit (chyb√≠ Match ID/ELO)`;
      }

      // group by tournament (col C)
      const groups = new Map();
      for (const r of cards){
        const key = r.tournament || "Nezn√°m√Ω turnaj";
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(r);
      }

      // stable ordering: tournaments by name, rows by matchId
      const tournamentNames = Array.from(groups.keys()).sort((a,b)=>a.localeCompare(b, "cs"));

      const sectionsHtml = tournamentNames.map(tn => {
        const rows = groups.get(tn).slice().sort((a,b) => (a.matchId||0) - (b.matchId||0));
        return `
          <div class="sectionTitle">${escapeHtml(tn)}</div>
          ${buildTournamentTable(rows)}
        `;
      }).join("");

      modalSub.textContent = "Detail hr√°ƒçe";
      modalBody.innerHTML = buildHero2col(playerObj) + sectionsHtml;

    } catch (e){
      modalSub.textContent = "Detail hr√°ƒçe";
      modalBody.innerHTML = buildHero2col(playerObj) +
        `<div class="bigError"><div class="icon">‚ùå</div> Podrobn√° data hr√°ƒçe nenalezena</div>` +
        `<div class="muted" style="margin-top:10px;">(Chyba p≈ôi ƒçten√≠ listu ‚Äû${escapeHtml(PLAYER_CARDS_SHEET_NAME)}‚Äú)</div>` +
        `<div class="muted" style="margin-top:6px;">${escapeHtml(String(e?.message || e))}</div>`;
    }
  }

  // events
  searchEl.addEventListener("input", () => renderStandings(allRows));
  refreshBtn.addEventListener("click", loadAll);
  requestUploadBtn.addEventListener("click", () => { window.location.href = "https://www.seznam.cz/"; });

  tbody.addEventListener("click", (e) => {
    const btn = e.target.closest(".playerBtn");
    if (!btn) return;
    const playerObj = btn._playerObj;
    if (!playerObj) return;
    loadPlayerDetail(playerObj);
  });

  closeModalBtn.addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) closeModal(); });
  window.addEventListener("keydown", (e) => { if (e.key === "Escape" && modalOverlay.style.display === "block") closeModal(); });

  // init
  loadAll();
</script>
</body>
</html>
